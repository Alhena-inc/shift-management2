# LINE シフト通知 セットアップガイド（Messaging API版）

このガイドでは、毎日21時に翌日のシフト内容をLINEグループに自動通知する機能の設定方法を説明します。

> ⚠️ **注意**: LINE Notifyは2025年3月31日でサービス終了しました。  
> このガイドでは後継の**LINE Messaging API**を使用します。

## 概要

- **機能**: 翌日のシフト内容をLINEグループに自動通知
- **実行時刻**: 毎日21時
- **通知形式**: ヘルパーごとにケア内容をリスト化
- **使用API**: LINE Messaging API（Push Message）

### 通知メッセージ例

```
1/12のシフト内容共有です

【新原】
16:30-18:30
池浦(家事)/2
2
東成区
19:15-20:45
岩戸(身体)/3
1.5
旭区

【熊本】
9:00-16:00
富岡(重度)/1
7
西成区

...

明日もよろしくお願いします
```

---

## 1. LINE公式アカウントの作成

### 1.1 LINE Developersにアクセス

1. LINE Developers Console にアクセス: https://developers.line.biz/console/
2. LINEアカウントでログイン
3. 「プロバイダー」を作成（初回のみ）

### 1.2 Messaging APIチャネルを作成

1. プロバイダーを選択
2. **「新規チャネル作成」** → **「Messaging API」** を選択
3. 以下の情報を入力：
   - チャネル名: `シフト通知Bot`（任意）
   - チャネル説明: `シフト内容をお知らせします`
   - 大業種: `その他`
   - 小業種: `その他`
4. **「作成」** をクリック

### 1.3 チャネルアクセストークンの発行

1. 作成したチャネルを選択
2. **「Messaging API設定」** タブを開く
3. 一番下の **「チャネルアクセストークン（長期）」** で **「発行」** をクリック
4. 表示されたトークンを**コピーして保存**

### 1.4 応答設定の変更

1. **「Messaging API設定」** タブ
2. 「LINE公式アカウント機能」の **「応答メッセージ」** → **「編集」**
3. LINE Official Account Managerが開く
4. 以下の設定に変更：
   - 応答メッセージ: **オフ**
   - Webhook: **オン**

---

## 2. グループIDの取得

LINEグループにメッセージを送信するには、グループIDが必要です。

### 2.1 Webhookを設定（推奨方法）

1. Google Apps Scriptで `line-shift-notify.gs` をデプロイ
   - デプロイ → 新しいデプロイ → 種類: **ウェブアプリ**
   - アクセスできるユーザー: **全員**
   - デプロイしてURLをコピー
2. LINE Developers Console → Messaging API設定
3. **Webhook URL** に デプロイしたURLを設定
4. **「Webhookの利用」** をオン
5. **「検証」** ボタンで接続確認

### 2.2 グループにBotを招待

1. LINE公式アカウントをグループに招待
   - Messaging API設定 → **「QRコード」** を表示
   - LINEアプリでQRコードを読み取って友だち追加
   - グループに招待
2. Botがグループに参加すると、Webhookでグループ IDが自動取得される
3. Google Apps Scriptの実行ログで `グループID: Cxxxx...` を確認

### 2.3 グループIDの確認方法（手動）

スプレッドシートに自動保存される場合：
1. スプレッドシートに「LINE設定」シートが自動作成される
2. グループIDが記録されている

---

## 3. Google Apps Script の設定

### 3.1 スクリプトを開く

**方法A: スプレッドシートから作成（推奨）**

1. 対象のスプレッドシートを開く
2. メニューから **「拡張機能」→「Apps Script」** を選択
3. 新しいスクリプトエディタが開く

**方法B: 独立したプロジェクトとして作成**

1. https://script.google.com/ にアクセス
2. **「新しいプロジェクト」** をクリック

### 3.2 コードを貼り付け

1. デフォルトの `コード.gs` を削除（または内容を全選択して削除）
2. `/shift-table/google-apps-script/line-shift-notify.gs` の内容をコピー
3. スクリプトエディタに貼り付け
4. **Ctrl+S** または **⌘+S** で保存

### 3.3 設定値を変更

スクリプト内の以下の値を変更します：

```javascript
// LINE Messaging API のチャネルアクセストークン（手順1.3で取得）
const LINE_CHANNEL_ACCESS_TOKEN = 'YOUR_CHANNEL_ACCESS_TOKEN';

// 送信先のグループID（手順2で取得）
const LINE_GROUP_ID = 'Cxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';

// スプレッドシートID
// URL: https://docs.google.com/spreadsheets/d/【このIDを使用】/edit
const SPREADSHEET_ID = '1asgiOLpVlrE6hZ1en_CnqIXa_JCZxjRUSW4kpbGcwMY';
```

---

## 4. 動作テスト

### 4.1 ログで確認（推奨）

1. スクリプトエディタで `testNotifyForDate` 関数を選択
2. **「実行」** ボタンをクリック
3. 初回は権限の承認が求められるので **「許可」** をクリック
4. **「実行ログ」** タブで結果を確認

### 4.2 テストメッセージ送信

1. `testSendMessage` 関数を選択
2. **「実行」** ボタンをクリック
3. LINEグループにテストメッセージが届くことを確認

### 4.3 実際にシフト通知

1. `notifyTomorrowShifts` 関数を選択
2. **「実行」** ボタンをクリック
3. LINEにシフト通知が届くことを確認

---

## 5. 自動実行トリガーの設定

### 5.1 スクリプトから設定（推奨）

1. スクリプトエディタで `setupDailyTrigger` 関数を選択
2. **「実行」** ボタンをクリック
3. トリガーが設定される（毎日21時に自動実行）

### 5.2 手動でトリガーを設定

1. スクリプトエディタの左メニューから **「トリガー」（時計アイコン）** をクリック
2. **「トリガーを追加」** ボタンをクリック
3. 以下の設定を行う：
   - 実行する関数: `notifyTomorrowShifts`
   - 実行するデプロイ: `Head`
   - イベントのソース: `時間主導型`
   - 時間ベースのトリガーのタイプ: `日付ベースのタイマー`
   - 時刻を選択: `午後9時〜10時`
4. **「保存」** をクリック

---

## 6. スプレッドシートメニューの追加（オプション）

スプレッドシートから直接実行したい場合：

1. スプレッドシートを再読み込み
2. メニューバーに **「📱 LINE通知」** が追加される
3. 以下の操作が可能：
   - 📤 明日のシフトを今すぐ通知
   - 🧪 テスト通知（ログのみ）
   - 📨 テストメッセージ送信
   - ⏰ 毎日21時のトリガーを設定
   - 🗑️ トリガーを削除

---

## 7. スプレッドシートの構造について

スクリプトは以下の構造を前提としています：

### 対象シート

- シート名が `🟢【今月】` で始まるシート（例: `🟢【今月】26.1月`）

### グリッド構造

| 行番号 | 内容 |
|--------|------|
| 4, 37, 70, 103, 136, 169 | 日付行 |
| 5, 38, 71, 104, 137, 170 | ヘルパー名行 |
| 6-25, 39-58, 72-91, ... | ケア内容（各20行） |

### 除外対象

以下のヘルパー名は通知対象外：
- 「合計」「合計枠」「予備」「予定」を含む
- 空欄

### 色による判定

| 背景色 | 判定 |
|--------|------|
| 赤系（#ff0000, #cc0000, #990000, #db4437） | キャンセル → 除外 |
| ピンク（#ff00ff） | 有効 → 含める |
| その他 | 有効 → 含める |

---

## 8. LINE Messaging APIの料金について

LINE Messaging APIは月間のメッセージ送信数に応じた料金体系です。

| プラン | 無料メッセージ通数 | 追加メッセージ料金 |
|--------|-------------------|------------------|
| コミュニケーションプラン | 200通/月 | 不可 |
| ライトプラン | 5,000通/月 | 不可 |
| スタンダードプラン | 30,000通/月 | 〜3円/通 |

毎日1回の通知であれば、**コミュニケーションプラン（無料）** で十分です。

詳細: https://www.linebiz.com/jp/service/line-official-account/plan/

---

## トラブルシューティング

### 通知が届かない

1. チャネルアクセストークンが正しいか確認
2. グループIDが正しいか確認（`C`で始まる文字列）
3. BotがグループにINVITEされているか確認
4. スクリプトの実行ログでエラーを確認

### 「401 Unauthorized」エラー

- チャネルアクセストークンが間違っている
- トークンを再発行して設定し直す

### 「400 Bad Request」エラー

- グループIDが間違っている
- Botがグループから退出している

### 「対象シートが見つかりません」

1. シート名が `🟢【今月】` で始まっているか確認
2. `TARGET_SHEET_PREFIX` の値を確認

### 「権限がありません」エラー

1. スクリプト実行時に権限を許可
2. 外部サービス（LINE API）へのアクセスを許可

### シフトが抽出されない

1. 日付行・ヘルパー名行が正しい位置にあるか確認
2. `GRID_CONFIG` の値を実際のシート構造に合わせて調整
3. `testNotifyForDate` でログを確認

---

## ファイル構成

```
/shift-table/google-apps-script/
├── line-shift-notify.gs    # LINE通知スクリプト（Messaging API版）
└── payroll-to-sheets.gs    # 給与明細スクリプト
```

---

## 参考リンク

- LINE Developers Console: https://developers.line.biz/console/
- Messaging API ドキュメント: https://developers.line.biz/ja/docs/messaging-api/
- Push Message API: https://developers.line.biz/ja/reference/messaging-api/#send-push-message

---

## お問い合わせ

設定でお困りの場合は、実行ログのエラーメッセージを添えてお問い合わせください。

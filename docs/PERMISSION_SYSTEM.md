# 権限管理システム仕様書

## 📋 権限レベル

### 1. 管理者（admin）
**全ての機能にアクセス可能**

#### 可能な操作：
- ✅ **ヘルパー管理**
  - ヘルパーの追加・編集・削除
  - 権限の変更（admin/staff）
  - 給与情報の編集
  - 個人情報の編集

- ✅ **シフト管理**
  - 全てのシフトの作成・編集・削除
  - 他のヘルパーのシフト編集
  - シフトデータの一括削除
  - 翌月への反映

- ✅ **給与計算**
  - 全ヘルパーの給与計算閲覧
  - 給与明細の作成・編集
  - 交通費・経費の編集

- ✅ **データ管理**
  - 内部バックアップの実行
  - データベースのクリーンアップ
  - システム設定の変更

- ✅ **利用者管理**
  - 利用者情報の追加・編集・削除

### 2. スタッフ（staff）
**制限付きアクセス**

#### 可能な操作：
- ✅ **自分のシフト管理**
  - 自分のシフトの閲覧
  - 休み希望の申請
  - 自分のシフトへのコメント追加

- ✅ **限定的な閲覧**
  - 他のヘルパーの名前とシフト時間（詳細は非表示）
  - 自分の給与明細のみ閲覧

- ❌ **不可能な操作**
  - ヘルパーの追加・削除
  - 他のヘルパーのシフト編集
  - 給与情報の編集
  - システム設定の変更
  - バックアップ機能
  - データ削除機能

## 🔧 実装箇所

### 1. Firestoreデータ構造
```javascript
// helpersコレクション
{
  id: "helper-xxx",
  name: "田中 太郎",
  email: "tanaka@example.com",
  role: "admin",  // または "staff"
  // ...
}

// usersコレクション
{
  uid: "firebase-uid",
  name: "田中 太郎",
  email: "tanaka@example.com",
  role: "admin",  // helpersから同期
  helperId: "helper-xxx",
  // ...
}
```

### 2. 権限チェック箇所

#### HomePage.tsx
- 管理者のみ表示：
  - ヘルパー管理
  - 利用者管理
  - 従業員フォーム管理

#### ShiftTable.tsx
- 管理者：全シフト編集可能
- スタッフ：自分のシフトのみ編集可能

#### HelperManager.tsx
- 管理者のみアクセス可能

#### SalaryCalculation.tsx
- 管理者：全員分を閲覧可能
- スタッフ：自分の分のみ閲覧可能

#### バックアップ・削除機能
- 管理者のみアクセス可能

## 🛡️ セキュリティルール

### Firestoreルール
```javascript
// helpers コレクション
match /helpers/{helperId} {
  // 読み取り：認証済みユーザー
  allow read: if request.auth != null;

  // 書き込み：管理者のみ
  allow write: if request.auth != null &&
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
}

// shifts コレクション
match /shifts/{shiftId} {
  // 読み取り：認証済みユーザー
  allow read: if request.auth != null;

  // 書き込み：管理者または自分のシフト
  allow write: if request.auth != null && (
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
    resource.data.helperId == request.auth.uid
  );
}
```

## 📊 権限別画面表示

### 管理者画面
```
🏠 ホーム
├── 👥 ヘルパー管理 ✅
├── 📅 ヘルパーシフト管理 ✅（全編集可）
├── 👤 利用者管理 ✅
├── 💰 給与明細 ✅（全員分）
└── 📝 従業員フォーム管理 ✅

シフト表画面
├── 💰 給与計算 ✅（全員分）
├── 👥 ヘルパー管理 ✅
├── 📊 交通費・経費 ✅
├── 🏖️ 休み希望 ✅
├── 📋 翌月へ反映 ✅
├── ☁️ 内部バックアップ ✅
└── 🗑️ シフトデータ削除 ✅
```

### スタッフ画面
```
🏠 ホーム
├── 👥 ヘルパー管理 ❌（非表示）
├── 📅 ヘルパーシフト管理 ✅（閲覧のみ）
├── 👤 利用者管理 ❌（非表示）
├── 💰 給与明細 ✅（自分のみ）
└── 📝 従業員フォーム管理 ❌（非表示）

シフト表画面
├── 💰 給与計算 ✅（自分のみ）
├── 👥 ヘルパー管理 ❌（非表示）
├── 📊 交通費・経費 ✅（自分のみ）
├── 🏖️ 休み希望 ✅
├── 📋 翌月へ反映 ❌（非表示）
├── ☁️ 内部バックアップ ❌（非表示）
└── 🗑️ シフトデータ削除 ❌（非表示）
```

## 🔄 権限変更手順

### 管理者による権限変更
1. Firebaseコンソールまたはヘルパー管理画面
2. 対象ヘルパーのroleフィールドを変更
3. 次回ログイン時から新しい権限が適用

### 初期設定
- デフォルト権限：`staff`
- 最初の管理者は手動でFirebaseコンソールから設定

## ⚠️ 注意事項

1. **権限の昇格は慎重に**
   - admin権限は全データにアクセス可能
   - 信頼できるユーザーのみに付与

2. **権限の確認**
   - ログイン時にヘッダーに表示
   - 「管理者モード」または「スタッフモード」

3. **セキュリティ**
   - クライアント側の制御だけでなくFirestoreルールでも保護
   - APIレベルでの権限チェック実装

---
最終更新: 2026年2月3日
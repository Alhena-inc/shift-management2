# ホワイトリスト認証（招待制）セットアップガイド

## 概要

このシステムは**ホワイトリスト方式（招待制）**を採用しています。
管理者が事前に登録したメールアドレスのみがログイン可能で、未登録のユーザーは自動的に拒否されます。

## 🔐 セキュリティ仕様

### 認証フロー

1. **Google認証** - `signInWithPopup`でGoogleアカウント情報を取得
2. **ホワイトリスト照合** - `helpers`コレクションでメールアドレスを検索
3. **アクセス制御**
   - ✅ 登録済み: ログイン許可 → uidを紐付け → usersコレクションを更新
   - ❌ 未登録: 即座にサインアウト → エラーメッセージ表示

## 📋 管理者向け：ユーザー登録手順

### 1. Firestoreでhelpersコレクションにユーザーを追加

Firebaseコンソール > Firestore Database > helpersコレクション

新規ドキュメントを作成：

```json
{
  "id": "helper_001",           // 必須：一意のヘルパーID
  "name": "田中 太郎",          // 必須：ユーザー名
  "email": "tanaka@example.com", // 必須：Googleアカウントのメールアドレス
  "role": "staff",               // 必須：権限（staff / admin）
  "gender": "male",              // オプション：性別
  "salaryType": "hourly",        // オプション：給与タイプ
  "hourlyWage": 1200,           // オプション：時給
  "transportationCosts": 500,    // オプション：交通費
  "order": 1                     // オプション：表示順
}
```

### 2. 権限レベル

| role | 権限 | 説明 |
|------|------|------|
| `admin` | 管理者 | 全機能へのアクセス、ユーザー管理、設定変更 |
| `staff` | スタッフ | シフト入力、自分の情報の閲覧・編集 |

### 3. ユーザー追加後の流れ

1. 管理者がhelpersコレクションにメールアドレスを登録
2. 該当ユーザーにログイン情報を連絡
3. ユーザーがGoogleログインを実行
4. 初回ログイン時に自動的にuidが紐付けられる

## 🚫 アクセス拒否されるケース

- helpersコレクションに登録されていないメールアドレス
- メールアドレスは登録されているが、Firestoreがアクセスできない
- ネットワークエラー

### エラーメッセージの例

```
このメールアドレス（user@example.com）は登録されていません。
管理者に連絡して、アクセス権限の付与を依頼してください。
```

## 🗑️ ユーザー削除手順

### 1. アクセス権限の取り消し

helpersコレクションから該当ドキュメントを削除またはemailフィールドを変更

```javascript
// Firebaseコンソール または Admin SDKで実行
await deleteDoc(doc(db, 'helpers', 'helper_001'));
```

### 2. 既存セッションの無効化（オプション）

Firebase Authentication > ユーザー > 該当ユーザーを無効化

## 📊 データ構造

### helpersコレクション（ホワイトリスト）

```typescript
interface Helper {
  id: string;                    // ヘルパーID
  name: string;                  // 名前
  email: string;                 // メールアドレス（ログイン用）
  role: 'admin' | 'staff';      // 権限
  uid?: string;                  // FirebaseユーザーID（ログイン後に紐付け）
  lastLoginAt?: Timestamp;       // 最終ログイン日時
  // ... その他のヘルパー情報
}
```

### usersコレクション（認証済みユーザー）

```typescript
interface User {
  uid: string;                   // Firebase UID
  email: string;                 // メールアドレス
  name: string;                  // 表示名
  role: 'admin' | 'staff';      // 権限
  helperId: string;              // helpersとの紐付け
  photoURL?: string;             // プロフィール画像
  createdAt: Timestamp;          // 作成日時
  lastLoginAt: Timestamp;        // 最終ログイン日時
}
```

## 🔧 トラブルシューティング

### Q: 登録したはずのユーザーがログインできない

**確認事項:**
1. helpersコレクションにメールアドレスが正確に登録されているか
2. メールアドレスの大文字/小文字が一致しているか
3. Firestoreのセキュリティルールで読み取りが許可されているか

### Q: 誤って未登録ユーザーがログインしてしまった

**対処法:**
1. helpersコレクションを確認
2. 該当ユーザーのドキュメントを削除
3. Firebase Authenticationからもユーザーを削除

### Q: 権限を変更したい

**手順:**
1. helpersコレクションの該当ドキュメントを編集
2. `role`フィールドを変更（admin ⇔ staff）
3. ユーザーは次回ログイン時に新しい権限が適用される

## 🛡️ セキュリティベストプラクティス

1. **定期的な監査**
   - helpersコレクションの登録者を定期的に確認
   - 不要なアカウントは速やかに削除

2. **メールアドレスの管理**
   - 会社ドメインのメールアドレスのみ許可を推奨
   - 個人のGmailアカウントは避ける

3. **権限の最小化**
   - デフォルトは`staff`権限
   - `admin`権限は必要最小限に

4. **ログの監視**
   - ログイン失敗の監視
   - 不審なアクセスパターンの検知

## 📝 実装チェックリスト

- [x] Login.tsxでホワイトリスト照合を実装
- [x] 未登録ユーザーの自動サインアウト
- [x] エラーメッセージの表示
- [x] helpersコレクションとusersコレクションの連携
- [x] uidの紐付け処理
- [ ] 管理者向けユーザー管理画面（今後実装予定）
- [ ] ログイン履歴の記録（今後実装予定）

---

最終更新: 2026年2月2日
# 給与明細作成機能のセットアップガイド

## 概要

このドキュメントでは、シフト管理ソフトの給与明細作成機能を使用するための手順を説明します。

## 機能説明

給与明細作成機能は、月次の給与計算データをGoogleスプレッドシートに自動で書き込む機能です。

### 主な機能

1. **給与データの自動計算**
   - 通常稼働時間・深夜稼働時間の集計
   - 同行時間・事務営業時間の集計
   - 稼働日数のカウント
   - 給与額の自動計算

2. **スプレッドシートへの自動書き込み**
   - テンプレートシートの自動コピー
   - 基本情報・勤怠項目・稼働時間の書き込み
   - 月次勤怠表の自動生成

3. **ヘルパー別の給与明細作成**
   - 時給制・固定給制の自動判定
   - 複数ヘルパーの一括処理

## 書き込み先スプレッドシート

- **スプレッドシートID**: `1asgiOLpVlrE6hZ1en_CnqIXa_JCZxjRUSW4kpbGcwMY`
- **テンプレートシート**:
  - 時給制: 「賃金明細(時給)」
  - 固定給制: 「賃金明細(固定)」

## 書き込み内容

### 基本情報
| セル | 内容 |
|------|------|
| D20 | ヘルパー氏名 |
| I18 | 基本単価 (1200円) |
| I19 | 合計時間単価 |
| I20 | 雇用形態 (時給/固定給) |

### 勤怠項目 (23行目)
| セル | 内容 |
|------|------|
| C23 | 通常稼働日数 |
| E23 | 同行稼働日数 |
| K23 | 合計稼働日数 |

### 稼働時間 (25行目)
| セル | 内容 |
|------|------|
| C25 | 通常稼働時間 |
| E25 | 同行時間 |
| G25 | 深夜稼働時間 |
| I25 | 深夜同行時間 |
| K25 | 事務・営業業務時間 |
| M25 | 合計稼働時間 |

### 支給項目
| セル | 内容 |
|------|------|
| C28 | 通常給与 |
| C30 | 経費 |
| E30 | 交通費 |

### 月勤怠表 (Q4〜Y35)
| 列 | 内容 |
|----|------|
| Q | 日付 (例: 12/1) |
| R | 曜日 |
| S | 通常稼働時間 |
| T | 通常深夜時間 |
| U | 同行時間 |
| V | 同行深夜時間 |
| W | 事務時間 |
| X | 営業時間 |
| Y | 合計時間 |

## サービス種別の分類

- **通常稼働**: 身体、重度、家事、通院、移動、行動
- **同行稼働**: 同行
- **事務**: 事務
- **営業**: 営業

## 稼働日数のカウント

- **通常稼働日数**: 通常サービス（身体、重度、家事など）を1件以上行った日をカウント
- **同行稼働日数**: 同行サービスを1件以上行った日をカウント
- **合計稼働日数**: 通常稼働日数と同行稼働日数の重複を除いた合計

## 深夜時間の計算

- **深夜時間帯**: 22:00〜翌8:00
- **深夜割増**: 通常時給の1.25倍で計算
- **深夜同行**: 1,200円 × 1.25 = 1,500円/時

## 使用方法

### 1. 給与計算画面を開く

1. シフト管理ソフトのメイン画面から「給与計算」を選択
2. 対象の年月を指定

### 2. 給与明細作成ボタンをクリック

給与計算画面の右上にある「給与明細作成」ボタンをクリックします。

### 3. ヘルパーを選択

1. 給与明細作成モーダルが表示されます
2. 給与明細を作成したいヘルパーを選択
   - 「全選択」ボタンで全員を選択可能
   - 個別にチェックボックスで選択可能
3. 各ヘルパーの給与形態（時給/固定給）が表示されます

### 4. 給与明細を作成

1. 「給与明細を作成」ボタンをクリック
2. 処理状況がリアルタイムで表示されます
3. 処理が完了すると、各ヘルパーの結果が表示されます

### 5. スプレッドシートで確認

1. Googleスプレッドシート（ID: `1asgiOLpVlrE6hZ1en_CnqIXa_JCZxjRUSW4kpbGcwMY`）を開く
2. 「ヘルパー名_○月」という名前のシートが作成されています
3. データが正しく書き込まれているか確認します

## Zapier MCPのセットアップ（重要）

現在、この機能を使用するには**Zapier MCPのセットアップが必要**です。

### セットアップ手順

1. **Claude Codeの設定ファイルを開く**
   ```bash
   open ~/.claude.json
   ```

2. **Zapier MCPサーバーを追加**

   `mcpServers`セクションに以下を追加:
   ```json
   {
     "mcpServers": {
       "zapier": {
         "command": "npx",
         "args": ["-y", "@modelcontextprotocol/server-zapier"],
         "env": {
           "ZAPIER_NLA_API_KEY": "あなたのZapier APIキー"
         }
       }
     }
   }
   ```

3. **Zapier APIキーを取得**

   1. [Zapier](https://zapier.com/)にログイン
   2. API設定ページでAPIキーを生成
   3. 上記の設定ファイルに貼り付け

4. **Claude Codeを再起動**

### Zapier MCPが利用可能になるまでの暫定対応

Zapier MCPのセットアップが完了するまでは、以下のいずれかの方法で給与明細を作成してください:

1. **Google Sheets API版を使用** (既存機能)
   - `src/services/payrollSheetsService.ts`の`sendPayrollToSheets`関数を使用
   - Google認証が必要

2. **手動でスプレッドシートに入力**
   - 給与計算画面で表示されるデータを参考に、手動で入力

## トラブルシューティング

### 給与明細作成ボタンが表示されない

- ブラウザのキャッシュをクリアしてください
- アプリケーションを再ビルドしてください: `npm run build`

### スプレッドシートにデータが書き込まれない

- Zapier MCPが正しくセットアップされているか確認してください
- Zapier APIキーが有効か確認してください
- スプレッドシートの共有設定を確認してください

### 給与データが正しく計算されない

- シフトデータが正しく入力されているか確認してください
- キャンセル状態が`remove_time`のシフトは計算に含まれません

## 技術詳細

### 実装ファイル

- **Zapier MCP連携サービス**: `src/services/zapierPayrollService.ts`
- **給与明細作成モーダル**: `src/components/PayrollStatementModal.tsx`
- **給与計算画面**: `src/components/SalaryCalculation.tsx`

### 給与計算ロジック

1. **時間計算**: `calculateNightHours`と`calculateRegularHours`関数で深夜時間と通常時間を分離
2. **サービス分類**: `classifyServiceType`関数でサービス種別を分類
3. **日次集計**: 各日のシフトデータを集計
4. **月次集計**: 日次データを月次で集計

### データフロー

```
シフトデータ
    ↓
calculatePayrollData (給与データ計算)
    ↓
prepareZapierUpdates (スプレッドシート更新データ準備)
    ↓
sendPayrollToSheetsViaZapier (Zapier MCP経由で送信)
    ↓
Googleスプレッドシート
```

## 今後の拡張予定

- [ ] Zapier MCPの実装を完成させる
- [ ] PDFでの給与明細出力機能
- [ ] メール送信機能
- [ ] 給与明細の履歴管理

## お問い合わせ

機能に関する質問や不具合がある場合は、開発チームまでお問い合わせください。

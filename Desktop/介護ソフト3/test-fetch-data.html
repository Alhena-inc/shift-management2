<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 2rem;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        .info {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .log {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }
        button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }
        button:hover {
            background: #34495e;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.85rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Google Sheets ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ</h1>

        <div class="info">
            <strong>ä»Šæ—¥ã®æ—¥ä»˜:</strong> <span id="today-date"></span><br>
            <strong>API Key:</strong> AIzaSyAswb_3bHmXdLzbpVBHkMkzvJ2nUagRUU0<br>
            <strong>Spreadsheet ID:</strong> 1718uvoE5eVthZqypmrbFyHj92T30uSogMSsdSF8-wpA<br>
            <strong>Sheet Name:</strong> ğŸ”´ã€ä»Šæœˆã€‘25.10æœˆ
        </div>

        <button onclick="fetchData()">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—</button>

        <div id="result"></div>
        <div id="log-container"></div>
    </div>

    <script>
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¡¨ç¤º
        const today = new Date();
        const todayStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥ (${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][today.getDay()]})`;
        document.getElementById('today-date').textContent = todayStr;

        function log(message, data = null) {
            console.log(message, data || '');
            const logContainer = document.getElementById('log-container');
            if (!logContainer.querySelector('.log')) {
                logContainer.innerHTML = '<h2>ãƒ­ã‚°:</h2><div class="log" id="log"></div>';
            }
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            let logText = `[${timestamp}] ${message}`;
            if (data) {
                logText += '\n' + JSON.stringify(data, null, 2);
            }
            logDiv.textContent += logText + '\n\n';
        }

        async function fetchData() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>';

            // ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = '';

            try {
                const apiKey = 'AIzaSyAswb_3bHmXdLzbpVBHkMkzvJ2nUagRUU0';
                const spreadsheetId = '1718uvoE5eVthZqypmrbFyHj92T30uSogMSsdSF8-wpA';
                const sheetName = 'ğŸ”´ã€ä»Šæœˆã€‘25.10æœˆ';
                const range = `${sheetName}!A1:GZ200`; // ZZã‚ˆã‚Šåºƒã„ç¯„å›²ã«æ‹¡å¤§
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;

                log('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹', { url });

                const response = await fetch(url);

                log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    log('APIã‚¨ãƒ©ãƒ¼', errorData);
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();

                log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿', {
                    è¡Œæ•°: data.values?.length || 0,
                    æœ€åˆã®5è¡Œ: data.values?.slice(0, 5) || []
                });

                if (!data.values || data.values.length === 0) {
                    resultDiv.innerHTML = '<div class="error">âŒ ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                // ä»Šæ—¥ã®æ—¥ä»˜ã§ã‚±ã‚¢å†…å®¹ã‚’æ¤œç´¢
                const todayDate = new Date().getDate();
                log('ä»Šæ—¥ã®æ—¥ä»˜', todayDate);

                // é€±ã®è¨­å®šï¼ˆé…åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯è¡Œç•ªå·-1ï¼‰
                // ç¬¬3é€±: æ—¥ä»˜è¡Œ64â†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹63, ãƒ˜ãƒ«ãƒ‘ãƒ¼è¡Œ65â†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹64, ã‚±ã‚¢66-85â†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹65-84
                const weekConfigs = [
                    { dateRow: 3, helperRow: 4, careStartRow: 5, careEndRow: 24 },
                    { dateRow: 33, helperRow: 34, careStartRow: 35, careEndRow: 54 },
                    { dateRow: 63, helperRow: 64, careStartRow: 65, careEndRow: 84 },
                    { dateRow: 93, helperRow: 94, careStartRow: 95, careEndRow: 114 },
                    { dateRow: 123, helperRow: 124, careStartRow: 125, careEndRow: 144 },
                    { dateRow: 153, helperRow: 154, careStartRow: 155, careEndRow: 174 }
                ];

                let foundData = [];

                weekConfigs.forEach((config, weekIndex) => {
                    if (config.dateRow >= data.values.length) return;

                    const dateRow = data.values[config.dateRow];
                    const helperRow = data.values[config.helperRow];

                    log(`ç¬¬${weekIndex + 1}é€±ã‚’æ¤œç´¢`, {
                        dateRowè¡Œç•ªå·: config.dateRow + 1,
                        dateRowåˆ—æ•°: dateRow?.length || 0,
                        helperRowè¡Œç•ªå·: config.helperRow + 1,
                        helperRowåˆ—æ•°: helperRow?.length || 0,
                        'æœ€åˆã®10åˆ—': {
                            dateRow: dateRow?.slice(0, 10) || [],
                            helperRow: helperRow?.slice(0, 10) || []
                        }
                    });

                    // ç¬¬3é€±ã®å ´åˆã¯64è¡Œç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ã—ãè¡¨ç¤º
                    if (weekIndex === 2 && dateRow) {
                        log('ç¬¬3é€±ï¼ˆ64è¡Œç›®ï¼‰ã®è©³ç´° - åˆ—70-80ä»˜è¿‘', {
                            'åˆ—70-80ã®æ—¥ä»˜': dateRow.slice(70, 80),
                            'åˆ—70-80ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼': helperRow?.slice(70, 80) || []
                        });
                    }

                    if (!dateRow || !helperRow) return;

                    // åˆ—ç•ªå·ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã«å¤‰æ›
                    function colToLetter(col) {
                        let letter = '';
                        while (col >= 0) {
                            letter = String.fromCharCode((col % 26) + 65) + letter;
                            col = Math.floor(col / 26) - 1;
                        }
                        return letter;
                    }

                    // æ—¥ä»˜åˆ—ã‚’æ¤œç´¢
                    for (let col = 0; col < dateRow.length; col++) {
                        const dateCell = String(dateRow[col] || '').trim();
                        const dateMatch = dateCell.match(/^(\d+)\(/);

                        if (dateMatch && parseInt(dateMatch[1]) === todayDate) {
                            const helperName = String(helperRow[col] || '').trim();

                            // ãƒ˜ãƒ«ãƒ‘ãƒ¼åãŒç©ºã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                            if (!helperName) {
                                continue;
                            }

                            log(`âœ“ ä»Šæ—¥ã®æ—¥ä»˜ã‚’ç™ºè¦‹ï¼`, {
                                é€±: weekIndex + 1,
                                åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: col,
                                åˆ—ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ: colToLetter(col),
                                ã‚»ãƒ«å†…å®¹: dateCell,
                                ãƒ˜ãƒ«ãƒ‘ãƒ¼: helperName
                            });

                            // ã‚±ã‚¢å†…å®¹ã‚’å–å¾—
                            const careContents = [];
                            log(`ã‚±ã‚¢å†…å®¹å–å¾—ç¯„å›²: è¡Œ${config.careStartRow + 1}ã€œ${config.careEndRow + 1}`);

                            for (let row = config.careStartRow; row <= config.careEndRow && row < data.values.length; row++) {
                                const careRow = data.values[row];
                                if (careRow && careRow[col]) {
                                    const content = String(careRow[col]).trim();
                                    if (content) {
                                        careContents.push(content);
                                        log(`  è¡Œ${row + 1}: ${content}`);
                                    }
                                }
                            }

                            foundData.push({
                                week: weekIndex + 1,
                                column: col,
                                columnLetter: colToLetter(col),
                                helperName: helperName,
                                careContents: careContents
                            });

                            log('ã‚±ã‚¢å†…å®¹ã¾ã¨ã‚', {
                                ãƒ˜ãƒ«ãƒ‘ãƒ¼: helperName,
                                ä»¶æ•°: careContents.length,
                                å†…å®¹: careContents
                            });
                        }
                    }
                });

                log('æ¤œç´¢çµæœã¾ã¨ã‚', {
                    è¦‹ã¤ã‹ã£ãŸä»¶æ•°: foundData.length,
                    ãƒ‡ãƒ¼ã‚¿: foundData
                });

                // çµæœã‚’è¡¨ç¤º
                if (foundData.length === 0) {
                    resultDiv.innerHTML = '<div class="error">âŒ ä»Šæ—¥ã®ã‚±ã‚¢å†…å®¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                } else {
                    let html = '<div class="success">âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼</div>';
                    html += `<h2>ä»Šæ—¥ã®ã‚±ã‚¢å†…å®¹ (${foundData.length}ä»¶)</h2>`;

                    foundData.forEach((item, index) => {
                        html += `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                                <h3 style="margin: 0 0 0.5rem 0;">
                                    ${index + 1}. ${item.helperName || 'ä¸æ˜'}
                                    <span style="font-size: 0.9rem; color: #666;">(ç¬¬${item.week}é€±ãƒ»${item.columnLetter}åˆ—ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹${item.column})</span>
                                </h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">è¡Œ</th>
                                            <th>å†…å®¹</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        item.careContents.forEach((content, idx) => {
                            html += `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${content}</td>
                                </tr>
                            `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });

                    resultDiv.innerHTML = html;
                }

            } catch (error) {
                log('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', {
                    message: error.message,
                    stack: error.stack
                });
                resultDiv.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            fetchData();
        });
    </script>
</body>
</html>

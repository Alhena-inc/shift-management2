/**
 * 源泉徴収税計算（令和7年分 月額表・甲欄）
 *
 * 甲欄：主たる給与（1か所のみの勤務先で、扶養控除等申告書を提出している場合）
 * 参考：国税庁「給与所得の源泉徴収税額表（令和7年分）」
 */

/**
 * 令和7年分 月額表（甲欄）の税額テーブル
 * [最低額, 最高額, 扶養0人の税額, 扶養1人の税額, 扶養2人の税額, ...]
 */
const TAX_TABLE: Array<[number, number, number, number, number, number, number, number, number, number]> = [
  // [下限, 上限, 扶養0, 扶養1, 扶養2, 扶養3, 扶養4, 扶養5, 扶養6, 扶養7]
  [88000, 89000, 130, 0, 0, 0, 0, 0, 0, 0],
  [89000, 90000, 160, 0, 0, 0, 0, 0, 0, 0],
  [90000, 91000, 190, 0, 0, 0, 0, 0, 0, 0],
  [91000, 92000, 230, 0, 0, 0, 0, 0, 0, 0],
  [92000, 93000, 260, 0, 0, 0, 0, 0, 0, 0],
  [93000, 94000, 290, 0, 0, 0, 0, 0, 0, 0],
  [94000, 95000, 320, 0, 0, 0, 0, 0, 0, 0],
  [95000, 96000, 350, 0, 0, 0, 0, 0, 0, 0],
  [96000, 97000, 380, 0, 0, 0, 0, 0, 0, 0],
  [97000, 98000, 410, 0, 0, 0, 0, 0, 0, 0],
  [98000, 99000, 440, 0, 0, 0, 0, 0, 0, 0],
  [99000, 101000, 470, 0, 0, 0, 0, 0, 0, 0],
  [101000, 103000, 540, 0, 0, 0, 0, 0, 0, 0],
  [103000, 105000, 610, 0, 0, 0, 0, 0, 0, 0],
  [105000, 107000, 680, 0, 0, 0, 0, 0, 0, 0],
  [107000, 109000, 750, 0, 0, 0, 0, 0, 0, 0],
  [109000, 111000, 820, 0, 0, 0, 0, 0, 0, 0],
  [111000, 113000, 890, 0, 0, 0, 0, 0, 0, 0],
  [113000, 115000, 960, 0, 0, 0, 0, 0, 0, 0],
  [115000, 117000, 1030, 0, 0, 0, 0, 0, 0, 0],
  [117000, 119000, 1100, 0, 0, 0, 0, 0, 0, 0],
  [119000, 121000, 1170, 0, 0, 0, 0, 0, 0, 0],
  [121000, 123000, 1240, 0, 0, 0, 0, 0, 0, 0],
  [123000, 125000, 1310, 0, 0, 0, 0, 0, 0, 0],
  [125000, 127000, 1380, 0, 0, 0, 0, 0, 0, 0],
  [127000, 129000, 1450, 0, 0, 0, 0, 0, 0, 0],
  [129000, 131000, 1520, 0, 0, 0, 0, 0, 0, 0],
  [131000, 133000, 1590, 0, 0, 0, 0, 0, 0, 0],
  [133000, 135000, 1660, 0, 0, 0, 0, 0, 0, 0],
  [135000, 137000, 1730, 0, 0, 0, 0, 0, 0, 0],
  [137000, 139000, 1800, 0, 0, 0, 0, 0, 0, 0],
  [139000, 141000, 1870, 0, 0, 0, 0, 0, 0, 0],
  [141000, 143000, 1940, 310, 0, 0, 0, 0, 0, 0],
  [143000, 145000, 2010, 380, 0, 0, 0, 0, 0, 0],
  [145000, 147000, 2080, 450, 0, 0, 0, 0, 0, 0],
  [147000, 149000, 2150, 520, 0, 0, 0, 0, 0, 0],
  [149000, 151000, 2220, 590, 0, 0, 0, 0, 0, 0],
  [151000, 153000, 2980, 660, 0, 0, 0, 0, 0, 0],
  [153000, 155000, 3050, 730, 0, 0, 0, 0, 0, 0],
  [155000, 157000, 3120, 800, 0, 0, 0, 0, 0, 0],
  [157000, 159000, 3190, 870, 0, 0, 0, 0, 0, 0],
  [159000, 161000, 3260, 940, 0, 0, 0, 0, 0, 0],
  [161000, 163000, 3330, 1010, 0, 0, 0, 0, 0, 0],
  [163000, 165000, 3400, 1080, 0, 0, 0, 0, 0, 0],
  [165000, 167000, 3470, 1150, 0, 0, 0, 0, 0, 0],
  [167000, 169000, 3540, 1220, 0, 0, 0, 0, 0, 0],
  [169000, 171000, 3610, 1290, 0, 0, 0, 0, 0, 0],
  [171000, 173000, 3680, 1360, 0, 0, 0, 0, 0, 0],
  [173000, 175000, 3750, 1430, 0, 0, 0, 0, 0, 0],
  [175000, 177000, 3820, 1500, 0, 0, 0, 0, 0, 0],
  [177000, 179000, 3890, 1570, 0, 0, 0, 0, 0, 0],
  [179000, 181000, 3960, 1640, 0, 0, 0, 0, 0, 0],
  [181000, 183000, 4030, 1710, 0, 0, 0, 0, 0, 0],
  [183000, 185000, 4100, 1780, 0, 0, 0, 0, 0, 0],
  [185000, 187000, 4170, 1850, 0, 0, 0, 0, 0, 0],
  [187000, 189000, 4240, 1920, 0, 0, 0, 0, 0, 0],
  [189000, 191000, 4310, 1990, 370, 0, 0, 0, 0, 0],
  [191000, 193000, 4380, 2060, 440, 0, 0, 0, 0, 0],
  [193000, 195000, 4450, 2130, 510, 0, 0, 0, 0, 0],
  [195000, 197000, 4520, 2200, 580, 0, 0, 0, 0, 0],
  [197000, 199000, 4590, 2270, 650, 0, 0, 0, 0, 0],
  [199000, 201000, 4660, 2340, 720, 0, 0, 0, 0, 0],
  [201000, 203000, 5130, 2410, 790, 0, 0, 0, 0, 0],
  [203000, 205000, 5200, 2480, 860, 0, 0, 0, 0, 0],
  [205000, 207000, 5270, 2550, 930, 0, 0, 0, 0, 0],
  [207000, 209000, 5340, 2620, 1000, 0, 0, 0, 0, 0],
  [209000, 211000, 5410, 2690, 1070, 0, 0, 0, 0, 0],
  [211000, 213000, 5480, 2760, 1140, 0, 0, 0, 0, 0],
  [213000, 215000, 5550, 2830, 1210, 0, 0, 0, 0, 0],
  [215000, 217000, 5620, 2900, 1280, 0, 0, 0, 0, 0],
  [217000, 219000, 5690, 2970, 1350, 0, 0, 0, 0, 0],
  [219000, 221000, 5760, 3040, 1420, 0, 0, 0, 0, 0],
  [221000, 223000, 5830, 3110, 1490, 0, 0, 0, 0, 0],
  [223000, 225000, 5900, 3180, 1560, 0, 0, 0, 0, 0],
  [225000, 227000, 5970, 3250, 1630, 0, 0, 0, 0, 0],
  [227000, 229000, 6040, 3320, 1700, 0, 0, 0, 0, 0],
  [229000, 231000, 6110, 3390, 1770, 0, 0, 0, 0, 0],
  [231000, 233000, 6180, 3460, 1840, 0, 0, 0, 0, 0],
  [233000, 235000, 6250, 3530, 1910, 0, 0, 0, 0, 0],
  [235000, 237000, 6320, 3600, 1980, 360, 0, 0, 0, 0],
  [237000, 239000, 6390, 3670, 2050, 430, 0, 0, 0, 0],
  [239000, 242000, 6320, 3710, 2080, 460, 0, 0, 0, 0],
  [242000, 245000, 6320, 3710, 2080, 460, 0, 0, 0, 0],
  [245000, 248000, 6420, 4810, 3200, 1570, 0, 0, 0, 0],
  [248000, 251000, 6530, 4920, 3300, 1680, 0, 0, 0, 0],
  [251000, 254000, 6640, 5020, 3410, 1790, 170, 0, 0, 0],
  [254000, 257000, 6760, 5150, 3530, 1920, 300, 0, 0, 0],
  [257000, 260000, 6880, 5270, 3660, 2040, 420, 0, 0, 0],
  [260000, 263000, 7000, 5390, 3780, 2160, 540, 0, 0, 0],
  [263000, 266000, 7130, 5520, 3900, 2290, 670, 0, 0, 0],
  [266000, 269000, 7260, 5650, 4030, 2420, 800, 0, 0, 0],
  [269000, 272000, 7390, 5780, 4160, 2550, 930, 0, 0, 0],
  [272000, 275000, 7530, 5910, 4300, 2680, 1060, 0, 0, 0],
  [278000, 281000, 7810, 6190, 4570, 2960, 1340, 0, 0, 0],
  [281000, 284000, 7960, 6330, 4720, 3100, 1490, 0, 0, 0],
  [284000, 287000, 8110, 6490, 4870, 3250, 1630, 10, 0, 0],
  [287000, 290000, 8260, 6650, 5020, 3410, 1790, 170, 0, 0],
  [290000, 293000, 8420, 6800, 5180, 3560, 1940, 320, 0, 0],
  [293000, 296000, 8580, 6960, 5340, 3720, 2100, 480, 0, 0],
  [296000, 299000, 8740, 7120, 5500, 3880, 2260, 640, 0, 0],
  [299000, 302000, 8900, 7280, 5660, 4040, 2420, 800, 0, 0],
  [283000, 285000, 8400, 5280, 3660, 2040, 420, 0, 0, 0],
  [285000, 287000, 8470, 5350, 3730, 2110, 490, 0, 0, 0],
  [287000, 289000, 8540, 5420, 3800, 2180, 560, 0, 0, 0],
  [289000, 291000, 8610, 5490, 3870, 2250, 630, 0, 0, 0],
  [291000, 293000, 8680, 5560, 3940, 2320, 700, 0, 0, 0],
  [293000, 295000, 8750, 5630, 4010, 2390, 770, 0, 0, 0],
  [295000, 297000, 8820, 5700, 4080, 2460, 840, 0, 0, 0],
  [297000, 299000, 8890, 5770, 4150, 2530, 910, 0, 0, 0],
  [299000, 301000, 8960, 5840, 4220, 2600, 980, 0, 0, 0],
  [301000, 303000, 8420, 5910, 4290, 2670, 1050, 0, 0, 0],
  [303000, 305000, 8490, 5980, 4360, 2740, 1120, 0, 0, 0],
  [305000, 307000, 8560, 6050, 4430, 2810, 1190, 0, 0, 0],
  [307000, 309000, 8630, 6120, 4500, 2880, 1260, 0, 0, 0],
  [309000, 311000, 8700, 6190, 4570, 2950, 1330, 0, 0, 0],
  [311000, 313000, 8770, 6260, 4640, 3020, 1400, 0, 0, 0],
  [313000, 315000, 8840, 6330, 4710, 3090, 1470, 0, 0, 0],
  [315000, 319000, 8950, 6440, 4820, 3200, 1580, 0, 0, 0],
  [319000, 323000, 9170, 6660, 5040, 3420, 1800, 0, 0, 0],
  [323000, 327000, 9390, 6880, 5260, 3640, 2020, 400, 0, 0],
  [327000, 331000, 9610, 7100, 5480, 3860, 2240, 620, 0, 0],
  [331000, 335000, 9830, 7320, 5700, 4080, 2460, 840, 0, 0],
  [335000, 339000, 10050, 7540, 5920, 4300, 2680, 1060, 0, 0],
  [339000, 343000, 10270, 7760, 6140, 4520, 2900, 1280, 0, 0],
  [343000, 347000, 10490, 7980, 6360, 4740, 3120, 1500, 0, 0],
  [347000, 351000, 10710, 8200, 6580, 4960, 3340, 1720, 0, 0],
  [351000, 355000, 10930, 8420, 6800, 5180, 3560, 1940, 320, 0],
  [355000, 359000, 11150, 8640, 7020, 5400, 3780, 2160, 540, 0],
  [359000, 363000, 11370, 8860, 7240, 5620, 4000, 2380, 760, 0],
  [363000, 367000, 11590, 9080, 7460, 5840, 4220, 2600, 980, 0],
  [367000, 371000, 11810, 9300, 7680, 6060, 4440, 2820, 1200, 0],
  [371000, 375000, 12030, 9520, 7900, 6280, 4660, 3040, 1420, 0],
  [375000, 379000, 12250, 9740, 8120, 6500, 4880, 3260, 1640, 0],
  [379000, 383000, 12470, 9960, 8340, 6720, 5100, 3480, 1860, 240],
  [383000, 387000, 12690, 10180, 8560, 6940, 5320, 3700, 2080, 460],
  [387000, 391000, 12910, 10400, 8780, 7160, 5540, 3920, 2300, 680],
  [391000, 395000, 13130, 10620, 9000, 7380, 5760, 4140, 2520, 900],
  [395000, 399000, 13350, 10840, 9220, 7600, 5980, 4360, 2740, 1120],
  [399000, 403000, 13570, 11060, 9440, 7820, 6200, 4580, 2960, 1340],
];

/**
 * 課税対象額から源泉徴収税を計算
 *
 * @param taxableAmount - 課税対象額（社会保険料控除後の金額）
 * @param dependents - 扶養人数（0〜7人以上）
 * @returns 源泉徴収税額（円）
 */
export function calculateWithholdingTax(taxableAmount: number, dependents: number = 0): number {
  // 88,000円未満は源泉徴収税なし
  if (taxableAmount < 88000) {
    return 0;
  }

  // 扶養人数は0〜7人、8人以上は7人として計算後に減額
  const dependentsForTable = Math.min(dependents, 7);
  const extraDependents = Math.max(0, dependents - 7);

  // テーブルから該当する税額を検索
  for (const row of TAX_TABLE) {
    const [min, max, ...taxes] = row;
    if (taxableAmount >= min && taxableAmount < max) {
      const baseTax = taxes[dependentsForTable] || 0;

      // 8人以上の場合、1人につき1,610円減額
      const extraDeduction = extraDependents * 1610;
      const finalTax = Math.max(0, baseTax - extraDeduction);

      return finalTax;
    }
  }

  // テーブルの範囲外（403,000円以上）の場合は月額表の計算式を使用
  // ここでは簡易的に最大値を返す（実際の実装では計算式が必要）
  const lastRow = TAX_TABLE[TAX_TABLE.length - 1];
  const baseTax = lastRow[2 + dependentsForTable] || 0;
  const extraDeduction = extraDependents * 1610;

  // 403,000円以上の場合の計算式（概算）
  const excessAmount = taxableAmount - 403000;
  const excessTax = Math.floor(excessAmount * 0.2042); // 20.42%の税率
  const finalTax = Math.max(0, baseTax + excessTax - extraDeduction);

  return Math.round(finalTax);
}

/**
 * 税額テーブルの範囲を取得（デバッグ用）
 */
export function getTaxTableRange(): { min: number; max: number } {
  return {
    min: TAX_TABLE[0][0],
    max: TAX_TABLE[TAX_TABLE.length - 1][1],
  };
}

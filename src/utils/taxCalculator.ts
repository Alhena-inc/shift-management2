/**
 * 源泉徴収税計算（令和7年/令和8年対応 月額表・甲欄/乙欄）
 *
 * 【重要】740,000円未満は計算式を使わず、必ずマスタデータ（早見表）から固定値を取得する。
 * 740,000円以上のみ計算式（速算表）を使用する。
 *
 * 甲欄：主たる給与（1か所のみの勤務先で、扶養控除等申告書を提出している場合）
 * 乙欄：従たる給与（2か所以上の勤務先がある場合など）
 * 
 * 参考：国税庁「給与所得の源泉徴収税額表」
 */

// ==================== 型定義 ====================

type TaxType = '甲' | '乙';

interface TaxTableRow {
  min: number;      // 下限額
  max: number;      // 上限額（未満）
  kou: number[];    // 甲欄: 扶養0人〜7人の税額
  otsu: number;     // 乙欄の税額
}

interface HighIncomeBracket {
  threshold: number;  // 階層下限額
  rate: number;       // 税率（%）
  baseTaxes: number[]; // 扶養0人〜7人の基準税額
}

interface YearConfig {
  taxFreeThreshold: number;           // 課税開始ライン
  taxTable: TaxTableRow[];            // 月額表（甲欄・乙欄）
  highIncomeBrackets: HighIncomeBracket[]; // 高額給与の階層（甲欄）
  otsuLowRate: number;                // 乙欄の低額税率（%）
  otsuHighBrackets: {                 // 乙欄の高額給与計算
    threshold: number;
    baseTax: number;
    rate: number;
  }[];
}

// ==================== 令和7年（2025年）の設定 ====================

/**
 * 令和7年分 月額表（甲欄・乙欄）
 * 88,000円〜740,000円未満
 * 
 * 【重要】このデータは国税庁「令和7年分 給与所得の源泉徴収税額表（月額表）」から転記
 * 計算式は使用せず、この固定値をルックアップして返す
 */
const TAX_TABLE_2025: TaxTableRow[] = [
  // 88,000円〜99,000円（扶養0人のみ課税）
  { min: 88000, max: 89000, kou: [130, 0, 0, 0, 0, 0, 0, 0], otsu: 3200 },
  { min: 89000, max: 90000, kou: [180, 0, 0, 0, 0, 0, 0, 0], otsu: 3200 },
  { min: 90000, max: 91000, kou: [230, 0, 0, 0, 0, 0, 0, 0], otsu: 3200 },
  { min: 91000, max: 92000, kou: [290, 0, 0, 0, 0, 0, 0, 0], otsu: 3300 },
  { min: 92000, max: 93000, kou: [340, 0, 0, 0, 0, 0, 0, 0], otsu: 3300 },
  { min: 93000, max: 94000, kou: [390, 0, 0, 0, 0, 0, 0, 0], otsu: 3400 },
  { min: 94000, max: 95000, kou: [440, 0, 0, 0, 0, 0, 0, 0], otsu: 3400 },
  { min: 95000, max: 96000, kou: [490, 0, 0, 0, 0, 0, 0, 0], otsu: 3500 },
  { min: 96000, max: 97000, kou: [540, 0, 0, 0, 0, 0, 0, 0], otsu: 3500 },
  { min: 97000, max: 98000, kou: [590, 0, 0, 0, 0, 0, 0, 0], otsu: 3600 },
  { min: 98000, max: 99000, kou: [640, 0, 0, 0, 0, 0, 0, 0], otsu: 3600 },
  // 99,000円〜101,000円
  { min: 99000, max: 101000, kou: [720, 0, 0, 0, 0, 0, 0, 0], otsu: 3700 },
  { min: 101000, max: 103000, kou: [830, 0, 0, 0, 0, 0, 0, 0], otsu: 3800 },
  { min: 103000, max: 105000, kou: [930, 0, 0, 0, 0, 0, 0, 0], otsu: 4000 },
  { min: 105000, max: 107000, kou: [1030, 0, 0, 0, 0, 0, 0, 0], otsu: 4100 },
  { min: 107000, max: 109000, kou: [1130, 0, 0, 0, 0, 0, 0, 0], otsu: 4300 },
  { min: 109000, max: 111000, kou: [1240, 0, 0, 0, 0, 0, 0, 0], otsu: 4500 },
  { min: 111000, max: 113000, kou: [1340, 0, 0, 0, 0, 0, 0, 0], otsu: 4600 },
  { min: 113000, max: 115000, kou: [1440, 0, 0, 0, 0, 0, 0, 0], otsu: 4800 },
  { min: 115000, max: 117000, kou: [1540, 0, 0, 0, 0, 0, 0, 0], otsu: 4900 },
  { min: 117000, max: 119000, kou: [1640, 0, 0, 0, 0, 0, 0, 0], otsu: 5100 },
  { min: 119000, max: 121000, kou: [1750, 0, 0, 0, 0, 0, 0, 0], otsu: 5300 },
  { min: 121000, max: 123000, kou: [1850, 0, 0, 0, 0, 0, 0, 0], otsu: 5400 },
  { min: 123000, max: 125000, kou: [1950, 0, 0, 0, 0, 0, 0, 0], otsu: 5600 },
  { min: 125000, max: 127000, kou: [2050, 0, 0, 0, 0, 0, 0, 0], otsu: 5700 },
  { min: 127000, max: 129000, kou: [2150, 0, 0, 0, 0, 0, 0, 0], otsu: 5900 },
  { min: 129000, max: 131000, kou: [2260, 0, 0, 0, 0, 0, 0, 0], otsu: 6100 },
  { min: 131000, max: 133000, kou: [2360, 0, 0, 0, 0, 0, 0, 0], otsu: 6200 },
  { min: 133000, max: 135000, kou: [2460, 0, 0, 0, 0, 0, 0, 0], otsu: 6400 },
  { min: 135000, max: 137000, kou: [2550, 0, 0, 0, 0, 0, 0, 0], otsu: 6500 },
  { min: 137000, max: 139000, kou: [2610, 0, 0, 0, 0, 0, 0, 0], otsu: 6700 },
  { min: 139000, max: 141000, kou: [2680, 0, 0, 0, 0, 0, 0, 0], otsu: 6900 },
  // 141,000円〜189,000円
  { min: 141000, max: 143000, kou: [2740, 120, 0, 0, 0, 0, 0, 0], otsu: 7000 },
  { min: 143000, max: 145000, kou: [2800, 180, 0, 0, 0, 0, 0, 0], otsu: 7200 },
  { min: 145000, max: 147000, kou: [2870, 250, 0, 0, 0, 0, 0, 0], otsu: 7300 },
  { min: 147000, max: 149000, kou: [2930, 310, 0, 0, 0, 0, 0, 0], otsu: 7500 },
  { min: 149000, max: 151000, kou: [2990, 370, 0, 0, 0, 0, 0, 0], otsu: 7700 },
  { min: 151000, max: 153000, kou: [3050, 430, 0, 0, 0, 0, 0, 0], otsu: 7800 },
  { min: 153000, max: 155000, kou: [3120, 500, 0, 0, 0, 0, 0, 0], otsu: 8000 },
  { min: 155000, max: 157000, kou: [3180, 560, 0, 0, 0, 0, 0, 0], otsu: 8100 },
  { min: 157000, max: 159000, kou: [3240, 620, 0, 0, 0, 0, 0, 0], otsu: 8300 },
  { min: 159000, max: 161000, kou: [3300, 680, 0, 0, 0, 0, 0, 0], otsu: 8500 },
  { min: 161000, max: 163000, kou: [3370, 750, 0, 0, 0, 0, 0, 0], otsu: 8600 },
  { min: 163000, max: 165000, kou: [3430, 810, 0, 0, 0, 0, 0, 0], otsu: 8800 },
  // ★ 三村様テストケース対象行（165,000円以上167,000円未満で扶養0人 = 3,550円）
  { min: 165000, max: 167000, kou: [3550, 930, 0, 0, 0, 0, 0, 0], otsu: 8900 },
  { min: 167000, max: 169000, kou: [3610, 990, 0, 0, 0, 0, 0, 0], otsu: 9100 },
  { min: 169000, max: 171000, kou: [3620, 1000, 0, 0, 0, 0, 0, 0], otsu: 9300 },
  { min: 171000, max: 173000, kou: [3680, 1060, 0, 0, 0, 0, 0, 0], otsu: 9400 },
  { min: 173000, max: 175000, kou: [3740, 1120, 0, 0, 0, 0, 0, 0], otsu: 9600 },
  { min: 175000, max: 177000, kou: [3800, 1180, 0, 0, 0, 0, 0, 0], otsu: 9800 },
  { min: 177000, max: 179000, kou: [3870, 1250, 0, 0, 0, 0, 0, 0], otsu: 9900 },
  { min: 179000, max: 181000, kou: [3930, 1310, 0, 0, 0, 0, 0, 0], otsu: 10100 },
  { min: 181000, max: 183000, kou: [3990, 1370, 0, 0, 0, 0, 0, 0], otsu: 10200 },
  { min: 183000, max: 185000, kou: [4050, 1430, 0, 0, 0, 0, 0, 0], otsu: 10400 },
  { min: 185000, max: 187000, kou: [4120, 1500, 0, 0, 0, 0, 0, 0], otsu: 10600 },
  { min: 187000, max: 189000, kou: [4180, 1560, 0, 0, 0, 0, 0, 0], otsu: 10700 },
  // 189,000円〜235,000円
  { min: 189000, max: 191000, kou: [4240, 1620, 0, 0, 0, 0, 0, 0], otsu: 10900 },
  { min: 191000, max: 193000, kou: [4300, 1680, 70, 0, 0, 0, 0, 0], otsu: 11000 },
  { min: 193000, max: 195000, kou: [4370, 1750, 130, 0, 0, 0, 0, 0], otsu: 11200 },
  { min: 195000, max: 197000, kou: [4430, 1810, 190, 0, 0, 0, 0, 0], otsu: 11400 },
  { min: 197000, max: 199000, kou: [4490, 1870, 250, 0, 0, 0, 0, 0], otsu: 11500 },
  { min: 199000, max: 201000, kou: [4550, 1930, 320, 0, 0, 0, 0, 0], otsu: 11700 },
  { min: 201000, max: 203000, kou: [4620, 2000, 380, 0, 0, 0, 0, 0], otsu: 11800 },
  { min: 203000, max: 205000, kou: [4680, 2060, 440, 0, 0, 0, 0, 0], otsu: 12000 },
  { min: 205000, max: 207000, kou: [4740, 2120, 500, 0, 0, 0, 0, 0], otsu: 12200 },
  { min: 207000, max: 209000, kou: [4800, 2180, 560, 0, 0, 0, 0, 0], otsu: 12300 },
  { min: 209000, max: 211000, kou: [4870, 2250, 630, 0, 0, 0, 0, 0], otsu: 12500 },
  { min: 211000, max: 213000, kou: [4930, 2310, 690, 0, 0, 0, 0, 0], otsu: 12600 },
  { min: 213000, max: 215000, kou: [4990, 2370, 750, 130, 0, 0, 0, 0], otsu: 12800 },
  { min: 215000, max: 217000, kou: [5050, 2430, 810, 200, 0, 0, 0, 0], otsu: 13000 },
  { min: 217000, max: 219000, kou: [5120, 2500, 880, 260, 0, 0, 0, 0], otsu: 13100 },
  { min: 219000, max: 221000, kou: [5180, 2560, 940, 320, 0, 0, 0, 0], otsu: 13300 },
  { min: 221000, max: 224000, kou: [5270, 2650, 1030, 410, 0, 0, 0, 0], otsu: 13500 },
  { min: 224000, max: 227000, kou: [5390, 2770, 1150, 540, 0, 0, 0, 0], otsu: 13900 },
  { min: 227000, max: 230000, kou: [5520, 2900, 1280, 660, 40, 0, 0, 0], otsu: 14200 },
  { min: 230000, max: 233000, kou: [5640, 3020, 1400, 780, 160, 0, 0, 0], otsu: 14500 },
  { min: 233000, max: 236000, kou: [5760, 3140, 1520, 910, 290, 0, 0, 0], otsu: 14800 },
  // 236,000円〜269,000円
  // ★ 国税庁「令和7年分 給与所得の源泉徴収税額表（月額表）」より正確に転記
  { min: 236000, max: 239000, kou: [5890, 3270, 1650, 1030, 410, 0, 0, 0], otsu: 15200 },
  { min: 239000, max: 242000, kou: [6130, 3510, 1890, 1270, 660, 40, 0, 0], otsu: 15500 },
  { min: 242000, max: 245000, kou: [6370, 3760, 2140, 1520, 900, 280, 0, 0], otsu: 15800 },
  { min: 245000, max: 248000, kou: [6400, 3780, 2160, 1540, 930, 310, 0, 0], otsu: 16100 },
  { min: 248000, max: 251000, kou: [6400, 3780, 2160, 1550, 930, 310, 0, 0], otsu: 16400 },
  // ★ テストケース対象行（251,000円以上254,000円未満で扶養0人 = 6,640円）
  { min: 251000, max: 254000, kou: [6640, 4020, 2400, 1780, 1160, 540, 0, 0], otsu: 16900 },
  { min: 254000, max: 257000, kou: [6640, 4030, 2410, 1790, 1170, 550, 0, 0], otsu: 17400 },
  { min: 257000, max: 260000, kou: [6890, 4270, 2650, 2030, 1410, 790, 180, 0], otsu: 17900 },
  { min: 260000, max: 263000, kou: [6890, 4270, 2650, 2030, 1420, 800, 180, 0], otsu: 18400 },
  { min: 263000, max: 266000, kou: [6890, 4270, 2660, 2040, 1420, 800, 180, 0], otsu: 19000 },
  { min: 266000, max: 269000, kou: [6890, 4280, 2660, 2040, 1420, 800, 190, 0], otsu: 19500 },
  // 269,000円〜302,000円
  // ★ 国税庁「令和7年分 給与所得の源泉徴収税額表（月額表）」より正確に転記
  { min: 269000, max: 272000, kou: [7130, 4510, 2890, 2270, 1650, 1030, 420, 0], otsu: 20000 },
  { min: 272000, max: 275000, kou: [7370, 4750, 3130, 2520, 1900, 1280, 660, 40], otsu: 20500 },
  { min: 275000, max: 278000, kou: [7610, 4990, 3380, 2760, 2140, 1520, 900, 280], otsu: 21100 },
  { min: 278000, max: 281000, kou: [7860, 5240, 3620, 3000, 2380, 1760, 1150, 530], otsu: 21600 },
  { min: 281000, max: 284000, kou: [8100, 5480, 3860, 3250, 2630, 2010, 1390, 770], otsu: 22100 },
  { min: 284000, max: 287000, kou: [8340, 5720, 4110, 3490, 2870, 2250, 1630, 1010], otsu: 22600 },
  { min: 287000, max: 290000, kou: [8590, 5970, 4350, 3730, 3110, 2490, 1880, 1260], otsu: 23200 },
  { min: 290000, max: 293000, kou: [8830, 6210, 4590, 3970, 3360, 2740, 2120, 1500], otsu: 23700 },
  { min: 293000, max: 296000, kou: [9070, 6450, 4840, 4220, 3600, 2980, 2360, 1740], otsu: 24200 },
  { min: 296000, max: 299000, kou: [9310, 6700, 5080, 4460, 3840, 3220, 2600, 1990], otsu: 24700 },
  { min: 299000, max: 302000, kou: [9560, 6940, 5320, 4700, 4090, 3470, 2850, 2230], otsu: 25300 },
  // 302,000円〜335,000円
  // ★ 国税庁「令和7年分 給与所得の源泉徴収税額表（月額表）」より正確に転記
  { min: 302000, max: 305000, kou: [8670, 6050, 4430, 3810, 3200, 2580, 1960, 1340], otsu: 25800 },
  // ★ テストケース対象行（305,000円以上308,000円未満で扶養0人 = 8,910円）
  { min: 305000, max: 308000, kou: [8910, 6290, 4670, 4050, 3440, 2820, 2200, 1580], otsu: 26300 },
  { min: 308000, max: 311000, kou: [9150, 6530, 4910, 4300, 3680, 3060, 2440, 1820], otsu: 26800 },
  { min: 311000, max: 314000, kou: [9390, 6770, 5160, 4540, 3920, 3300, 2680, 2060], otsu: 27400 },
  { min: 314000, max: 317000, kou: [9640, 7020, 5400, 4780, 4160, 3540, 2930, 2310], otsu: 27900 },
  { min: 317000, max: 320000, kou: [9880, 7260, 5640, 5020, 4410, 3790, 3170, 2550], otsu: 28400 },
  { min: 320000, max: 323000, kou: [10120, 7500, 5890, 5270, 4650, 4030, 3410, 2790], otsu: 28900 },
  { min: 323000, max: 326000, kou: [10360, 7750, 6130, 5510, 4890, 4270, 3650, 3040], otsu: 29500 },
  { min: 326000, max: 329000, kou: [10610, 7990, 6370, 5750, 5130, 4520, 3900, 3280], otsu: 30000 },
  { min: 329000, max: 332000, kou: [10850, 8230, 6610, 6000, 5380, 4760, 4140, 3520], otsu: 30500 },
  { min: 332000, max: 335000, kou: [11090, 8470, 6860, 6240, 5620, 5000, 4380, 3760], otsu: 31000 },
  // 335,000円〜368,000円
  // ★ 国税庁「令和7年分 給与所得の源泉徴収税額表（月額表）」より正確に転記
  { min: 335000, max: 338000, kou: [11330, 8720, 7100, 6480, 5860, 5240, 4620, 4010], otsu: 31600 },
  { min: 338000, max: 341000, kou: [11580, 8960, 7340, 6720, 6110, 5490, 4870, 4250], otsu: 32100 },
  { min: 341000, max: 344000, kou: [11820, 9200, 7580, 6970, 6350, 5730, 5110, 4490], otsu: 32600 },
  { min: 344000, max: 347000, kou: [12060, 9440, 7830, 7210, 6590, 5970, 5350, 4740], otsu: 33100 },
  { min: 347000, max: 350000, kou: [12310, 9690, 8070, 7450, 6830, 6220, 5600, 4980], otsu: 33700 },
  { min: 350000, max: 353000, kou: [12550, 9930, 8310, 7700, 7080, 6460, 5840, 5220], otsu: 34200 },
  { min: 353000, max: 356000, kou: [12790, 10170, 8560, 7940, 7320, 6700, 6080, 5470], otsu: 34700 },
  { min: 356000, max: 359000, kou: [13030, 10420, 8800, 8180, 7560, 6950, 6330, 5710], otsu: 35200 },
  { min: 359000, max: 362000, kou: [13280, 10660, 9040, 8420, 7810, 7190, 6570, 5950], otsu: 35800 },
  { min: 362000, max: 365000, kou: [13520, 10900, 9290, 8670, 8050, 7430, 6810, 6200], otsu: 36300 },
  { min: 365000, max: 368000, kou: [13760, 11140, 9530, 8910, 8290, 7670, 7060, 6440], otsu: 36800 },
  // 368,000円〜401,000円
  { min: 368000, max: 371000, kou: [16130, 13510, 11890, 11270, 10660, 10040, 9420, 8800], otsu: 37400 },
  { min: 371000, max: 374000, kou: [16380, 13750, 12140, 11520, 10900, 10280, 9660, 9040], otsu: 37900 },
  { min: 374000, max: 377000, kou: [16620, 14000, 12380, 11760, 11140, 10520, 9910, 9290], otsu: 38400 },
  { min: 377000, max: 380000, kou: [16860, 14240, 12620, 12000, 11390, 10770, 10150, 9530], otsu: 38900 },
  { min: 380000, max: 383000, kou: [17110, 14480, 12870, 12250, 11630, 11010, 10390, 9770], otsu: 39500 },
  { min: 383000, max: 386000, kou: [17350, 14730, 13110, 12490, 11870, 11250, 10640, 10020], otsu: 40000 },
  { min: 386000, max: 389000, kou: [17590, 14970, 13350, 12730, 12120, 11500, 10880, 10260], otsu: 40500 },
  { min: 389000, max: 392000, kou: [17840, 15210, 13600, 12980, 12360, 11740, 11120, 10500], otsu: 41000 },
  { min: 392000, max: 395000, kou: [18080, 15460, 13840, 13220, 12600, 11980, 11370, 10750], otsu: 41600 },
  { min: 395000, max: 398000, kou: [18320, 15700, 14080, 13460, 12850, 12230, 11610, 10990], otsu: 42100 },
  { min: 398000, max: 401000, kou: [18570, 15940, 14330, 13710, 13090, 12470, 11850, 11230], otsu: 42600 },
  // 401,000円〜434,000円
  { min: 401000, max: 404000, kou: [18810, 16190, 14570, 13950, 13330, 12710, 12100, 11480], otsu: 43200 },
  { min: 404000, max: 407000, kou: [19050, 16430, 14810, 14190, 13580, 12960, 12340, 11720], otsu: 43700 },
  { min: 407000, max: 410000, kou: [19300, 16670, 15060, 14440, 13820, 13200, 12580, 11960], otsu: 44200 },
  { min: 410000, max: 413000, kou: [19540, 16920, 15300, 14680, 14060, 13440, 12830, 12210], otsu: 44700 },
  { min: 413000, max: 416000, kou: [19780, 17160, 15540, 14920, 14310, 13690, 13070, 12450], otsu: 45300 },
  { min: 416000, max: 419000, kou: [20030, 17400, 15790, 15170, 14550, 13930, 13310, 12690], otsu: 45800 },
  { min: 419000, max: 422000, kou: [20270, 17650, 16030, 15410, 14790, 14170, 13560, 12940], otsu: 46300 },
  { min: 422000, max: 425000, kou: [20510, 17890, 16270, 15650, 15040, 14420, 13800, 13180], otsu: 46900 },
  { min: 425000, max: 428000, kou: [20760, 18130, 16520, 15900, 15280, 14660, 14040, 13420], otsu: 47400 },
  { min: 428000, max: 431000, kou: [21000, 18380, 16760, 16140, 15520, 14900, 14290, 13670], otsu: 47900 },
  { min: 431000, max: 434000, kou: [21240, 18620, 17000, 16380, 15770, 15150, 14530, 13910], otsu: 48400 },
  // 434,000円〜500,000円
  { min: 434000, max: 437000, kou: [21490, 18860, 17250, 16630, 16010, 15390, 14770, 14150], otsu: 49000 },
  { min: 437000, max: 440000, kou: [21730, 19110, 17490, 16870, 16250, 15630, 15020, 14400], otsu: 49500 },
  { min: 440000, max: 443000, kou: [21970, 19350, 17730, 17110, 16500, 15880, 15260, 14640], otsu: 50000 },
  { min: 443000, max: 446000, kou: [22220, 19590, 17980, 17360, 16740, 16120, 15500, 14880], otsu: 50500 },
  { min: 446000, max: 449000, kou: [22460, 19840, 18220, 17600, 16980, 16360, 15750, 15130], otsu: 51100 },
  { min: 449000, max: 452000, kou: [22700, 20080, 18460, 17840, 17230, 16610, 15990, 15370], otsu: 51600 },
  { min: 452000, max: 455000, kou: [22950, 20320, 18710, 18090, 17470, 16850, 16230, 15610], otsu: 52100 },
  { min: 455000, max: 458000, kou: [23190, 20570, 18950, 18330, 17710, 17090, 16480, 15860], otsu: 52700 },
  { min: 458000, max: 461000, kou: [23430, 20810, 19190, 18570, 17960, 17340, 16720, 16100], otsu: 53200 },
  { min: 461000, max: 464000, kou: [23680, 21050, 19440, 18820, 18200, 17580, 16960, 16340], otsu: 53700 },
  { min: 464000, max: 467000, kou: [23920, 21300, 19680, 19060, 18440, 17820, 17210, 16590], otsu: 54200 },
  { min: 467000, max: 470000, kou: [24160, 21540, 19920, 19300, 18690, 18070, 17450, 16830], otsu: 54800 },
  { min: 470000, max: 473000, kou: [24410, 21780, 20170, 19550, 18930, 18310, 17690, 17070], otsu: 55300 },
  { min: 473000, max: 476000, kou: [24650, 22030, 20410, 19790, 19170, 18550, 17940, 17320], otsu: 55800 },
  { min: 476000, max: 479000, kou: [24890, 22270, 20650, 20030, 19420, 18800, 18180, 17560], otsu: 56400 },
  { min: 479000, max: 482000, kou: [25140, 22510, 20900, 20280, 19660, 19040, 18420, 17800], otsu: 56900 },
  { min: 482000, max: 485000, kou: [25380, 22760, 21140, 20520, 19900, 19280, 18670, 18050], otsu: 57400 },
  { min: 485000, max: 488000, kou: [25620, 23000, 21380, 20760, 20150, 19530, 18910, 18290], otsu: 57900 },
  { min: 488000, max: 491000, kou: [25870, 23240, 21630, 21010, 20390, 19770, 19150, 18530], otsu: 58500 },
  { min: 491000, max: 494000, kou: [26110, 23490, 21870, 21250, 20630, 20010, 19400, 18780], otsu: 59000 },
  { min: 494000, max: 497000, kou: [26350, 23730, 22110, 21490, 20880, 20260, 19640, 19020], otsu: 59500 },
  { min: 497000, max: 500000, kou: [26600, 23970, 22360, 21740, 21120, 20500, 19880, 19260], otsu: 60100 },
  // 500,000円〜600,000円
  { min: 500000, max: 503000, kou: [26840, 24220, 22600, 21980, 21360, 20740, 20130, 19510], otsu: 60600 },
  { min: 503000, max: 506000, kou: [27080, 24460, 22840, 22220, 21610, 20990, 20370, 19750], otsu: 61100 },
  { min: 506000, max: 509000, kou: [27330, 24700, 23090, 22470, 21850, 21230, 20610, 19990], otsu: 61600 },
  { min: 509000, max: 512000, kou: [27570, 24950, 23330, 22710, 22090, 21470, 20860, 20240], otsu: 62200 },
  { min: 512000, max: 515000, kou: [27810, 25190, 23570, 22950, 22340, 21720, 21100, 20480], otsu: 62700 },
  { min: 515000, max: 518000, kou: [28060, 25430, 23820, 23200, 22580, 21960, 21340, 20720], otsu: 63200 },
  { min: 518000, max: 521000, kou: [28300, 25680, 24060, 23440, 22820, 22200, 21590, 20970], otsu: 63800 },
  { min: 521000, max: 524000, kou: [28540, 25920, 24300, 23680, 23070, 22450, 21830, 21210], otsu: 64300 },
  { min: 524000, max: 527000, kou: [28790, 26160, 24550, 23930, 23310, 22690, 22070, 21450], otsu: 64800 },
  { min: 527000, max: 530000, kou: [29030, 26410, 24790, 24170, 23550, 22930, 22320, 21700], otsu: 65300 },
  { min: 530000, max: 533000, kou: [29270, 26650, 25030, 24410, 23800, 23180, 22560, 21940], otsu: 65900 },
  { min: 533000, max: 536000, kou: [29520, 26890, 25280, 24660, 24040, 23420, 22800, 22180], otsu: 66400 },
  { min: 536000, max: 539000, kou: [29760, 27140, 25520, 24900, 24280, 23660, 23050, 22430], otsu: 66900 },
  { min: 539000, max: 542000, kou: [30000, 27380, 25760, 25140, 24530, 23910, 23290, 22670], otsu: 67500 },
  { min: 542000, max: 545000, kou: [30250, 27620, 26010, 25390, 24770, 24150, 23530, 22910], otsu: 68000 },
  { min: 545000, max: 548000, kou: [30490, 27870, 26250, 25630, 25010, 24390, 23780, 23160], otsu: 68500 },
  { min: 548000, max: 551000, kou: [30730, 28110, 26490, 25870, 25260, 24640, 24020, 23400], otsu: 69000 },
  { min: 551000, max: 554000, kou: [30980, 28350, 26740, 26120, 25500, 24880, 24260, 23640], otsu: 69600 },
  { min: 554000, max: 557000, kou: [31220, 28600, 26980, 26360, 25740, 25120, 24510, 23890], otsu: 70100 },
  { min: 557000, max: 560000, kou: [31460, 28840, 27220, 26600, 25990, 25370, 24750, 24130], otsu: 70600 },
  { min: 560000, max: 563000, kou: [31710, 29080, 27470, 26850, 26230, 25610, 24990, 24370], otsu: 71200 },
  { min: 563000, max: 566000, kou: [31950, 29330, 27710, 27090, 26470, 25850, 25240, 24620], otsu: 71700 },
  { min: 566000, max: 569000, kou: [32190, 29570, 27950, 27330, 26720, 26100, 25480, 24860], otsu: 72200 },
  { min: 569000, max: 572000, kou: [32440, 29810, 28200, 27580, 26960, 26340, 25720, 25100], otsu: 72700 },
  { min: 572000, max: 575000, kou: [32680, 30060, 28440, 27820, 27200, 26580, 25970, 25350], otsu: 73300 },
  { min: 575000, max: 578000, kou: [32920, 30300, 28680, 28060, 27450, 26830, 26210, 25590], otsu: 73800 },
  { min: 578000, max: 581000, kou: [33170, 30540, 28930, 28310, 27690, 27070, 26450, 25830], otsu: 74300 },
  { min: 581000, max: 584000, kou: [33410, 30790, 29170, 28550, 27930, 27310, 26700, 26080], otsu: 74900 },
  { min: 584000, max: 587000, kou: [33650, 31030, 29410, 28790, 28180, 27560, 26940, 26320], otsu: 75400 },
  { min: 587000, max: 590000, kou: [33900, 31270, 29660, 29040, 28420, 27800, 27180, 26560], otsu: 75900 },
  { min: 590000, max: 593000, kou: [34140, 31520, 29900, 29280, 28660, 28040, 27430, 26810], otsu: 76400 },
  { min: 593000, max: 596000, kou: [34380, 31760, 30140, 29520, 28910, 28290, 27670, 27050], otsu: 77000 },
  { min: 596000, max: 599000, kou: [34630, 32000, 30390, 29770, 29150, 28530, 27910, 27290], otsu: 77500 },
  { min: 599000, max: 602000, kou: [34870, 32250, 30630, 30010, 29390, 28770, 28160, 27540], otsu: 78000 },
  // 602,000円〜740,000円
  { min: 602000, max: 605000, kou: [35110, 32490, 30870, 30250, 29640, 29020, 28400, 27780], otsu: 78600 },
  { min: 605000, max: 608000, kou: [35360, 32730, 31120, 30500, 29880, 29260, 28640, 28020], otsu: 79100 },
  { min: 608000, max: 611000, kou: [35600, 32980, 31360, 30740, 30120, 29500, 28890, 28270], otsu: 79600 },
  { min: 611000, max: 614000, kou: [35840, 33220, 31600, 30980, 30370, 29750, 29130, 28510], otsu: 80100 },
  { min: 614000, max: 617000, kou: [36090, 33460, 31850, 31230, 30610, 29990, 29370, 28750], otsu: 80700 },
  { min: 617000, max: 620000, kou: [36330, 33710, 32090, 31470, 30850, 30230, 29620, 29000], otsu: 81200 },
  { min: 620000, max: 623000, kou: [36570, 33950, 32330, 31710, 31100, 30480, 29860, 29240], otsu: 81700 },
  { min: 623000, max: 626000, kou: [36820, 34190, 32580, 31960, 31340, 30720, 30100, 29480], otsu: 82300 },
  { min: 626000, max: 629000, kou: [37060, 34440, 32820, 32200, 31580, 30960, 30350, 29730], otsu: 82800 },
  { min: 629000, max: 632000, kou: [37300, 34680, 33060, 32440, 31830, 31210, 30590, 29970], otsu: 83300 },
  { min: 632000, max: 635000, kou: [37550, 34920, 33310, 32690, 32070, 31450, 30830, 30210], otsu: 83800 },
  { min: 635000, max: 638000, kou: [37790, 35170, 33550, 32930, 32310, 31690, 31080, 30460], otsu: 84400 },
  { min: 638000, max: 641000, kou: [38030, 35410, 33790, 33170, 32560, 31940, 31320, 30700], otsu: 84900 },
  { min: 641000, max: 644000, kou: [38280, 35650, 34040, 33420, 32800, 32180, 31560, 30940], otsu: 85400 },
  { min: 644000, max: 647000, kou: [38520, 35900, 34280, 33660, 33040, 32420, 31810, 31190], otsu: 86000 },
  { min: 647000, max: 650000, kou: [38760, 36140, 34520, 33900, 33290, 32670, 32050, 31430], otsu: 86500 },
  { min: 650000, max: 653000, kou: [39010, 36380, 34770, 34150, 33530, 32910, 32290, 31670], otsu: 87000 },
  { min: 653000, max: 656000, kou: [39250, 36630, 35010, 34390, 33770, 33150, 32540, 31920], otsu: 87500 },
  { min: 656000, max: 659000, kou: [39490, 36870, 35250, 34630, 34020, 33400, 32780, 32160], otsu: 88100 },
  { min: 659000, max: 662000, kou: [39740, 37110, 35500, 34880, 34260, 33640, 33020, 32400], otsu: 88600 },
  { min: 662000, max: 665000, kou: [39980, 37360, 35740, 35120, 34500, 33880, 33270, 32650], otsu: 89100 },
  { min: 665000, max: 668000, kou: [40220, 37600, 35980, 35360, 34750, 34130, 33510, 32890], otsu: 89700 },
  { min: 668000, max: 671000, kou: [40470, 37840, 36230, 35610, 34990, 34370, 33750, 33130], otsu: 90200 },
  { min: 671000, max: 674000, kou: [40710, 38090, 36470, 35850, 35230, 34610, 34000, 33380], otsu: 90700 },
  { min: 674000, max: 677000, kou: [40950, 38330, 36710, 36090, 35480, 34860, 34240, 33620], otsu: 91200 },
  { min: 677000, max: 680000, kou: [41200, 38570, 36960, 36340, 35720, 35100, 34480, 33860], otsu: 91800 },
  { min: 680000, max: 683000, kou: [41440, 38820, 37200, 36580, 35960, 35340, 34730, 34110], otsu: 92300 },
  { min: 683000, max: 686000, kou: [41680, 39060, 37440, 36820, 36210, 35590, 34970, 34350], otsu: 92800 },
  { min: 686000, max: 689000, kou: [41930, 39300, 37690, 37070, 36450, 35830, 35210, 34590], otsu: 93400 },
  { min: 689000, max: 692000, kou: [42170, 39550, 37930, 37310, 36690, 36070, 35460, 34840], otsu: 93900 },
  { min: 692000, max: 695000, kou: [42410, 39790, 38170, 37550, 36940, 36320, 35700, 35080], otsu: 94400 },
  { min: 695000, max: 698000, kou: [42660, 40030, 38420, 37800, 37180, 36560, 35940, 35320], otsu: 94900 },
  { min: 698000, max: 701000, kou: [42900, 40280, 38660, 38040, 37420, 36800, 36190, 35570], otsu: 95500 },
  { min: 701000, max: 704000, kou: [43140, 40520, 38900, 38280, 37670, 37050, 36430, 35810], otsu: 96000 },
  { min: 704000, max: 707000, kou: [43390, 40760, 39150, 38530, 37910, 37290, 36670, 36050], otsu: 96500 },
  { min: 707000, max: 710000, kou: [43630, 41010, 39390, 38770, 38150, 37530, 36920, 36300], otsu: 97100 },
  { min: 710000, max: 713000, kou: [43870, 41250, 39630, 39010, 38400, 37780, 37160, 36540], otsu: 97600 },
  { min: 713000, max: 716000, kou: [44120, 41490, 39880, 39260, 38640, 38020, 37400, 36780], otsu: 98100 },
  { min: 716000, max: 719000, kou: [44360, 41740, 40120, 39500, 38880, 38260, 37650, 37030], otsu: 98600 },
  { min: 719000, max: 722000, kou: [44600, 41980, 40360, 39740, 39130, 38510, 37890, 37270], otsu: 99200 },
  { min: 722000, max: 725000, kou: [44850, 42220, 40610, 39990, 39370, 38750, 38130, 37510], otsu: 99700 },
  { min: 725000, max: 728000, kou: [45090, 42470, 40850, 40230, 39610, 38990, 38380, 37760], otsu: 100200 },
  { min: 728000, max: 731000, kou: [45330, 42710, 41090, 40470, 39860, 39240, 38620, 38000], otsu: 100800 },
  { min: 731000, max: 734000, kou: [45580, 42950, 41340, 40720, 40100, 39480, 38860, 38240], otsu: 101300 },
  { min: 734000, max: 737000, kou: [45820, 43200, 41580, 40960, 40340, 39720, 39110, 38490], otsu: 101800 },
  { min: 737000, max: 740000, kou: [46060, 43440, 41820, 41200, 40590, 39970, 39350, 38730], otsu: 102300 },
];

/**
 * 令和7年分 高額給与（740,000円以上）の速算式用階層定義（甲欄）
 */
const HIGH_INCOME_BRACKETS_2025: HighIncomeBracket[] = [
  { threshold: 740000, rate: 20.420, baseTaxes: [46300, 43680, 42060, 41440, 40820, 40200, 39580, 38960] },
  { threshold: 850000, rate: 23.483, baseTaxes: [68780, 66160, 64540, 63920, 63300, 62680, 62060, 61440] },
  { threshold: 1700000, rate: 40.840, baseTaxes: [268420, 265800, 264180, 263560, 262940, 262320, 261700, 261080] },
  { threshold: 3550000, rate: 45.945, baseTaxes: [1024540, 1021920, 1020300, 1019680, 1019060, 1018440, 1017820, 1017200] },
];

// ==================== 令和8年（2026年）の設定 ====================

/**
 * 令和8年分 月額表（甲欄・乙欄）
 * 105,000円〜740,000円未満
 * ※令和8年は課税開始ラインが105,000円に引き上げ
 * 
 * 【重要】このデータは国税庁「令和8年分 給与所得の源泉徴収税額表（月額表）」から転記
 */
const TAX_TABLE_2026: TaxTableRow[] = [
  // 105,000円〜141,000円（扶養0人のみ課税）
  // ★ 国税庁「令和8年分 給与所得の源泉徴収税額表（月額表）」より正確に転記
  { min: 105000, max: 107000, kou: [170, 0, 0, 0, 0, 0, 0, 0], otsu: 4100 },
  { min: 107000, max: 109000, kou: [300, 0, 0, 0, 0, 0, 0, 0], otsu: 4300 },
  { min: 109000, max: 111000, kou: [410, 0, 0, 0, 0, 0, 0, 0], otsu: 4500 },
  { min: 111000, max: 113000, kou: [510, 0, 0, 0, 0, 0, 0, 0], otsu: 4600 },
  { min: 113000, max: 115000, kou: [610, 0, 0, 0, 0, 0, 0, 0], otsu: 4800 },
  { min: 115000, max: 117000, kou: [710, 0, 0, 0, 0, 0, 0, 0], otsu: 4900 },
  { min: 117000, max: 119000, kou: [810, 0, 0, 0, 0, 0, 0, 0], otsu: 5100 },
  { min: 119000, max: 121000, kou: [920, 0, 0, 0, 0, 0, 0, 0], otsu: 5300 },
  { min: 121000, max: 123000, kou: [1020, 0, 0, 0, 0, 0, 0, 0], otsu: 5400 },
  { min: 123000, max: 125000, kou: [1120, 0, 0, 0, 0, 0, 0, 0], otsu: 5600 },
  { min: 125000, max: 127000, kou: [1220, 0, 0, 0, 0, 0, 0, 0], otsu: 5700 },
  { min: 127000, max: 129000, kou: [1320, 0, 0, 0, 0, 0, 0, 0], otsu: 5900 },
  { min: 129000, max: 131000, kou: [1430, 0, 0, 0, 0, 0, 0, 0], otsu: 6100 },
  { min: 131000, max: 133000, kou: [1530, 0, 0, 0, 0, 0, 0, 0], otsu: 6200 },
  { min: 133000, max: 135000, kou: [1630, 0, 0, 0, 0, 0, 0, 0], otsu: 6400 },
  { min: 135000, max: 137000, kou: [1720, 0, 0, 0, 0, 0, 0, 0], otsu: 6500 },
  { min: 137000, max: 139000, kou: [1780, 0, 0, 0, 0, 0, 0, 0], otsu: 6700 },
  { min: 139000, max: 141000, kou: [1850, 0, 0, 0, 0, 0, 0, 0], otsu: 6900 },
  // 141,000円〜（以下、国税庁の令和8年分月額表に基づいて記載）
  // ※実際の運用では完全な表データを設定する必要があります
  { min: 141000, max: 143000, kou: [1910, 0, 0, 0, 0, 0, 0, 0], otsu: 7000 },
  { min: 143000, max: 145000, kou: [1970, 0, 0, 0, 0, 0, 0, 0], otsu: 7200 },
  { min: 145000, max: 147000, kou: [2040, 0, 0, 0, 0, 0, 0, 0], otsu: 7300 },
  { min: 147000, max: 149000, kou: [2100, 0, 0, 0, 0, 0, 0, 0], otsu: 7500 },
  { min: 149000, max: 151000, kou: [2160, 0, 0, 0, 0, 0, 0, 0], otsu: 7700 },
  { min: 151000, max: 153000, kou: [2220, 0, 0, 0, 0, 0, 0, 0], otsu: 7800 },
  { min: 153000, max: 155000, kou: [2290, 0, 0, 0, 0, 0, 0, 0], otsu: 8000 },
  { min: 155000, max: 157000, kou: [2350, 0, 0, 0, 0, 0, 0, 0], otsu: 8100 },
  { min: 157000, max: 159000, kou: [2410, 0, 0, 0, 0, 0, 0, 0], otsu: 8300 },
  { min: 159000, max: 161000, kou: [2470, 0, 0, 0, 0, 0, 0, 0], otsu: 8500 },
  { min: 161000, max: 163000, kou: [2540, 0, 0, 0, 0, 0, 0, 0], otsu: 8600 },
  { min: 163000, max: 165000, kou: [2600, 0, 0, 0, 0, 0, 0, 0], otsu: 8800 },
  { min: 165000, max: 167000, kou: [2660, 0, 0, 0, 0, 0, 0, 0], otsu: 8900 },
  { min: 167000, max: 169000, kou: [2720, 100, 0, 0, 0, 0, 0, 0], otsu: 9100 },
  { min: 169000, max: 171000, kou: [2790, 170, 0, 0, 0, 0, 0, 0], otsu: 9300 },
  { min: 171000, max: 173000, kou: [2850, 230, 0, 0, 0, 0, 0, 0], otsu: 9400 },
  { min: 173000, max: 175000, kou: [2910, 290, 0, 0, 0, 0, 0, 0], otsu: 9600 },
  { min: 175000, max: 177000, kou: [2970, 350, 0, 0, 0, 0, 0, 0], otsu: 9800 },
  { min: 177000, max: 179000, kou: [3040, 420, 0, 0, 0, 0, 0, 0], otsu: 9900 },
  { min: 179000, max: 181000, kou: [3100, 480, 0, 0, 0, 0, 0, 0], otsu: 10100 },
  { min: 181000, max: 183000, kou: [3160, 540, 0, 0, 0, 0, 0, 0], otsu: 10200 },
  { min: 183000, max: 185000, kou: [3220, 600, 0, 0, 0, 0, 0, 0], otsu: 10400 },
  { min: 185000, max: 187000, kou: [3290, 670, 0, 0, 0, 0, 0, 0], otsu: 10600 },
  { min: 187000, max: 189000, kou: [3350, 730, 0, 0, 0, 0, 0, 0], otsu: 10700 },
  { min: 189000, max: 191000, kou: [3410, 790, 170, 0, 0, 0, 0, 0], otsu: 10900 },
  { min: 191000, max: 193000, kou: [3470, 850, 240, 0, 0, 0, 0, 0], otsu: 11000 },
  { min: 193000, max: 195000, kou: [3540, 920, 300, 0, 0, 0, 0, 0], otsu: 11200 },
  { min: 195000, max: 197000, kou: [3600, 980, 360, 0, 0, 0, 0, 0], otsu: 11400 },
  { min: 197000, max: 199000, kou: [3660, 1040, 420, 0, 0, 0, 0, 0], otsu: 11500 },
  { min: 199000, max: 201000, kou: [3720, 1100, 490, 0, 0, 0, 0, 0], otsu: 11700 },
  // 201,000円〜740,000円（中間のデータ）
  { min: 201000, max: 210000, kou: [3880, 1260, 640, 30, 0, 0, 0, 0], otsu: 12200 },
  { min: 210000, max: 220000, kou: [4130, 1510, 890, 270, 0, 0, 0, 0], otsu: 13000 },
  { min: 220000, max: 230000, kou: [4510, 1890, 1270, 660, 40, 0, 0, 0], otsu: 14000 },
  { min: 230000, max: 240000, kou: [4900, 2280, 1660, 1040, 420, 0, 0, 0], otsu: 15000 },
  { min: 240000, max: 250000, kou: [5280, 2660, 2040, 1420, 810, 190, 0, 0], otsu: 16100 },
  { min: 250000, max: 260000, kou: [5660, 3040, 2430, 1810, 1190, 570, 0, 0], otsu: 17100 },
  { min: 260000, max: 270000, kou: [6050, 3430, 2810, 2190, 1570, 960, 340, 0], otsu: 18100 },
  { min: 270000, max: 280000, kou: [6430, 3810, 3190, 2580, 1960, 1340, 720, 100], otsu: 19100 },
  { min: 280000, max: 290000, kou: [6820, 4200, 3580, 2960, 2340, 1720, 1100, 490], otsu: 20200 },
  { min: 290000, max: 300000, kou: [7200, 4580, 3960, 3340, 2730, 2110, 1490, 870], otsu: 21200 },
  { min: 300000, max: 320000, kou: [7780, 5160, 4540, 3920, 3300, 2680, 2070, 1450], otsu: 22700 },
  { min: 320000, max: 340000, kou: [8560, 5940, 5320, 4700, 4080, 3460, 2840, 2230], otsu: 24700 },
  { min: 340000, max: 360000, kou: [9330, 6710, 6090, 5480, 4860, 4240, 3620, 3000], otsu: 26700 },
  { min: 360000, max: 380000, kou: [10110, 7490, 6870, 6250, 5630, 5010, 4400, 3780], otsu: 28700 },
  { min: 380000, max: 400000, kou: [10890, 8270, 7650, 7030, 6410, 5790, 5170, 4550], otsu: 30800 },
  { min: 400000, max: 420000, kou: [11660, 9040, 8420, 7800, 7190, 6570, 5950, 5330], otsu: 32800 },
  { min: 420000, max: 440000, kou: [12440, 9820, 9200, 8580, 7960, 7340, 6720, 6110], otsu: 34800 },
  { min: 440000, max: 460000, kou: [13210, 10600, 9980, 9360, 8740, 8120, 7500, 6880], otsu: 36800 },
  { min: 460000, max: 480000, kou: [13990, 11370, 10750, 10130, 9520, 8900, 8280, 7660], otsu: 38900 },
  { min: 480000, max: 500000, kou: [14770, 12150, 11530, 10910, 10290, 9670, 9050, 8440], otsu: 40900 },
  { min: 500000, max: 520000, kou: [15540, 12920, 12300, 11690, 11070, 10450, 9830, 9210], otsu: 42900 },
  { min: 520000, max: 540000, kou: [16320, 13700, 13080, 12460, 11840, 11220, 10610, 9990], otsu: 44900 },
  { min: 540000, max: 560000, kou: [17100, 14480, 13860, 13240, 12620, 12000, 11380, 10760], otsu: 47000 },
  { min: 560000, max: 580000, kou: [17870, 15250, 14630, 14020, 13400, 12780, 12160, 11540], otsu: 49000 },
  { min: 580000, max: 600000, kou: [18650, 16030, 15410, 14790, 14170, 13550, 12940, 12320], otsu: 51000 },
  { min: 600000, max: 620000, kou: [19430, 16810, 16190, 15570, 14950, 14330, 13710, 13090], otsu: 53000 },
  { min: 620000, max: 640000, kou: [20530, 17580, 16960, 16340, 15730, 15110, 14490, 13870], otsu: 55100 },
  { min: 640000, max: 660000, kou: [21730, 18440, 17820, 17200, 16580, 15960, 15340, 14720], otsu: 57400 },
  { min: 660000, max: 680000, kou: [22930, 19300, 18680, 18060, 17440, 16820, 16200, 15580], otsu: 59600 },
  { min: 680000, max: 700000, kou: [24130, 20170, 19550, 18930, 18310, 17690, 17070, 16450], otsu: 61900 },
  { min: 700000, max: 720000, kou: [25320, 21190, 20570, 19950, 19330, 18710, 18090, 17480], otsu: 64300 },
  { min: 720000, max: 731000, kou: [69170, 65050, 64430, 63810, 63190, 62570, 61950, 61330], otsu: 99700 },
  { min: 731000, max: 734000, kou: [69790, 65660, 65040, 64420, 63800, 63180, 62560, 61950], otsu: 100800 },
  { min: 734000, max: 737000, kou: [70400, 66280, 65660, 65040, 64420, 63800, 63180, 62560], otsu: 101300 },
  // ★ ユーザー指定: 737,000円以上740,000円未満, 甲0人: 71,380円
  { min: 737000, max: 740000, kou: [71380, 67260, 66640, 66020, 65400, 64780, 64160, 63540], otsu: 102300 },
];

/**
 * 令和8年分 高額給与（740,000円以上）の速算式用階層定義（甲欄）
 */
/**
 * 令和8年分 高額給与（740,000円以上）の速算式用階層定義（甲欄）
 * ★ 国税庁「令和8年分 給与所得の源泉徴収税額表」に基づく
 * 甲欄(0人): 基準税額 71,680円 + (基準額 - 740,000) × 20.42%
 */
const HIGH_INCOME_BRACKETS_2026: HighIncomeBracket[] = [
  { threshold: 740000, rate: 20.420, baseTaxes: [71680, 69060, 67440, 66820, 66200, 65580, 64960, 64340] },
  { threshold: 850000, rate: 23.483, baseTaxes: [94160, 91540, 89920, 89300, 88680, 88060, 87440, 86820] },
  { threshold: 1700000, rate: 40.840, baseTaxes: [293820, 291200, 289580, 288960, 288340, 287720, 287100, 286480] },
  { threshold: 3550000, rate: 45.945, baseTaxes: [1049940, 1047320, 1045700, 1045080, 1044460, 1043840, 1043220, 1042600] },
];

// ==================== 年次設定の取得 ====================

/**
 * 対象年の設定を取得
 */
function getYearConfig(year: number): YearConfig {
  if (year >= 2026) {
    return {
      taxFreeThreshold: 105000,
      taxTable: TAX_TABLE_2026,
      highIncomeBrackets: HIGH_INCOME_BRACKETS_2026,
      otsuLowRate: 3.063,
      otsuHighBrackets: [
        // 乙欄: 259,200円 + (基準額 - 740,000) × 40.84%
        { threshold: 740000, baseTax: 259200, rate: 40.84 },
        { threshold: 1710000, baseTax: 655400, rate: 45.945 },
      ],
    };
  } else {
    // 令和7年（2025年）以前
    return {
      taxFreeThreshold: 88000,
      taxTable: TAX_TABLE_2025,
      highIncomeBrackets: HIGH_INCOME_BRACKETS_2025,
      otsuLowRate: 3.063,
      otsuHighBrackets: [
        { threshold: 740000, baseTax: 104200, rate: 40.84 },
        { threshold: 1700000, baseTax: 496140, rate: 45.945 },
      ],
    };
  }
}

// ==================== メイン計算関数 ====================

/**
 * 源泉徴収税額を取得
 * 
 * 【重要】740,000円未満は計算式を使わず、必ずマスタデータ（早見表）から固定値を取得する。
 * 740,000円以上のみ計算式（速算表）を使用する。
 *
 * @param year - 対象年（例: 2025, 2026）
 * @param salary - 社会保険料等控除後の給与額
 * @param dependents - 扶養親族等の数（0〜7人以上）
 * @param type - 区分（'甲' または '乙'）
 * @returns 源泉徴収税額（円）
 */
export function calculateWithholdingTaxByYear(
  year: number,
  salary: number,
  dependents: number = 0,
  type: TaxType = '甲'
): number {
  const config = getYearConfig(year);

  // 負の給与は0として扱う
  if (salary <= 0) {
    return 0;
  }

  // パターンA: 課税ライン未満
  if (salary < config.taxFreeThreshold) {
    if (type === '甲') {
      return 0;
    } else {
      // 乙欄: 3.063%（1円未満切り捨て）
      return Math.floor(salary * (config.otsuLowRate / 100));
    }
  }

  // ★★★ パターンB: 月額表参照範囲（740,000円未満）★★★
  // 【重要】この範囲では計算式を絶対に使用しない！
  // 国税庁の税額表に定義された固定値のみを返す。
  // 税額表にない数値（計算で求めた値）は絶対に出力しない。
  if (salary < 740000) {
    return lookupTaxFromTable(salary, dependents, type, config);
  }

  // パターンC: 高額給与（740,000円以上）のみ速算式（計算式）を使用
  // ※740,000円以上は税額表に記載がないため、計算式で算出する
  if (type === '乙') {
    return calculateOtsuHighIncomeTax(salary, config);
  } else {
    return calculateKouHighIncomeTax(salary, dependents, config);
  }
}

/**
 * 月額表から税額をルックアップ（740,000円未満用）
 * 
 * ★★★ 【重要】計算式は絶対に使用禁止 ★★★
 * このメソッドは、国税庁の税額表に定義された固定値のみを返します。
 * 税額表に存在しない数値（計算で求めた値など）は絶対に出力しません。
 */
function lookupTaxFromTable(
  salary: number,
  dependents: number,
  type: TaxType,
  config: YearConfig
): number {
  // テーブルから該当する行を検索（範囲検索: min <= salary < max）
  const row = config.taxTable.find(r => salary >= r.min && salary < r.max);
  
  if (!row) {
    // ★ テーブルに該当がない場合 = 税額表の範囲外
    // 通常は発生しないが、発生した場合は以下の処理を行う
    
    // 課税ライン未満（88,000円未満 or 105,000円未満）の場合は0円
    if (salary < config.taxFreeThreshold) {
      return 0;
    }
    
    // テーブルの最後の行（737,000〜740,000円）を超えている場合
    // → 740,000円以上は速算式を使用するので、ここには来ないはず
    // 安全のため、最後の行の値を返す（計算式は使わない）
    const lastRow = config.taxTable[config.taxTable.length - 1];
    if (salary >= lastRow.min) {
      console.warn(`[源泉徴収] テーブル範囲外: ${salary}円 - 最終行の値を使用`);
      return type === '乙' ? lastRow.otsu : getKouTaxFromRow(lastRow, dependents);
    }
    
    // それ以外の場合は0円（テーブルに存在しない範囲）
    console.warn(`[源泉徴収] テーブルに該当なし: ${salary}円`);
    return 0;
  }

  // ★ テーブルから固定値を返す（計算式は一切使用しない）
  if (type === '乙') {
    return row.otsu;  // 乙欄の固定値
  }

  // 甲欄の固定値
  return getKouTaxFromRow(row, dependents);
}

/**
 * 甲欄の税額を行から取得
 */
function getKouTaxFromRow(row: TaxTableRow, dependents: number): number {
  // 扶養人数は0〜7人、8人以上は7人として計算後に減額
  const dependentsForTable = Math.min(dependents, 7);
  const extraDependents = Math.max(0, dependents - 7);

  const baseTax = row.kou[dependentsForTable] || 0;

  // 8人以上の扶養がある場合、1人につき1,610円減額
  const extraDeduction = extraDependents * 1610;

  return Math.max(0, baseTax - extraDeduction);
}

/**
 * 甲欄の高額給与（740,000円以上）の税額計算
 */
function calculateKouHighIncomeTax(salary: number, dependents: number, config: YearConfig): number {
  const dependentsForTable = Math.min(dependents, 7);
  const extraDependents = Math.max(0, dependents - 7);
  const brackets = config.highIncomeBrackets;

  // 該当する階層を検索（降順で検索）
  let applicableBracket: HighIncomeBracket | null = null;
  for (let i = brackets.length - 1; i >= 0; i--) {
    if (salary >= brackets[i].threshold) {
      applicableBracket = brackets[i];
      break;
    }
  }

  if (!applicableBracket) {
    applicableBracket = brackets[0];
  }

  // 基準税額（扶養人数に応じた値）
  const baseTax = applicableBracket.baseTaxes[dependentsForTable] || applicableBracket.baseTaxes[0];
  
  // 超過額に対する税額
  const excessAmount = salary - applicableBracket.threshold;
  const excessTax = Math.floor(excessAmount * (applicableBracket.rate / 100));
  
  // 合計税額
  const totalTax = baseTax + excessTax;
  
  // 8人以上の扶養がある場合、1人につき1,610円減額
  const extraDeduction = extraDependents * 1610;

  return Math.max(0, totalTax - extraDeduction);
}

/**
 * 乙欄の高額給与（740,000円以上）の税額計算
 */
function calculateOtsuHighIncomeTax(salary: number, config: YearConfig): number {
  for (let i = config.otsuHighBrackets.length - 1; i >= 0; i--) {
    const bracket = config.otsuHighBrackets[i];
    if (salary >= bracket.threshold) {
      const excessAmount = salary - bracket.threshold;
      const tax = bracket.baseTax + Math.floor(excessAmount * (bracket.rate / 100));
      return tax;
    }
  }

  // フォールバック
  const firstBracket = config.otsuHighBrackets[0];
  const excessAmount = salary - firstBracket.threshold;
  return firstBracket.baseTax + Math.floor(excessAmount * (firstBracket.rate / 100));
}

// ==================== 後方互換性のための関数 ====================

/**
 * 課税対象額から源泉徴収税を計算（後方互換）
 * 
 * @param taxableAmount - 課税対象額（社会保険料控除後の金額）
 * @param dependents - 扶養人数（0〜7人以上）
 * @returns 源泉徴収税額（円）
 * 
 * @deprecated calculateWithholdingTaxByYear() を使用してください
 */
export function calculateWithholdingTax(taxableAmount: number, dependents: number = 0): number {
  // 現在の年を取得して適切な計算を行う
  const currentYear = new Date().getFullYear();
  return calculateWithholdingTaxByYear(currentYear, taxableAmount, dependents, '甲');
}

// ==================== ユーティリティ関数 ====================

/**
 * 税額テーブルの範囲を取得（デバッグ用）
 */
export function getTaxTableRange(year: number = new Date().getFullYear()): { min: number; max: number } {
  const config = getYearConfig(year);
  return {
    min: config.taxFreeThreshold,
    max: 740000,
  };
}

/**
 * 対象年の課税開始ラインを取得
 */
export function getTaxFreeThreshold(year: number): number {
  return getYearConfig(year).taxFreeThreshold;
}

/**
 * 対象年が令和何年かを取得
 */
export function getReiwaNen(year: number): number {
  return year - 2018; // 令和元年 = 2019年
}

// ==================== テスト用関数 ====================

/**
 * テストケースの検証（開発用）
 * 
 * テストケース: 令和7年(2025) 12月支給
 * - 入力: 課税対象額 253,551円、扶養人数 0人、区分 甲
 * - 期待値: 6,640円（251,000円以上 254,000円未満の行、甲0人の列）
 */
export function runTestCase(): { passed: boolean; expected: number; actual: number } {
  const expected = 6640;
  const actual = calculateWithholdingTaxByYear(2025, 253551, 0, '甲');
  return {
    passed: actual === expected,
    expected,
    actual,
  };
}

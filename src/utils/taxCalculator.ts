/**
 * 源泉徴収税計算（令和7年/令和8年対応 月額表・甲欄/乙欄）
 *
 * 甲欄：主たる給与（1か所のみの勤務先で、扶養控除等申告書を提出している場合）
 * 乙欄：従たる給与（2か所以上の勤務先がある場合など）
 * 
 * 参考：国税庁「給与所得の源泉徴収税額表」
 */

// ==================== 型定義 ====================

type TaxType = '甲' | '乙';

interface TaxTableRow {
  min: number;      // 下限額
  max: number;      // 上限額（未満）
  taxes: number[];  // 扶養0人〜7人の税額
}

interface HighIncomeBracket {
  threshold: number;  // 階層下限額
  rate: number;       // 税率（%）
  baseTaxes: number[]; // 扶養0人〜7人の基準税額
}

interface YearConfig {
  taxFreeThreshold: number;           // 課税開始ライン
  taxTable: TaxTableRow[];            // 月額表（甲欄）
  highIncomeBrackets: HighIncomeBracket[]; // 高額給与の階層（甲欄）
  otsuLowRate: number;                // 乙欄の低額税率（%）
  otsuHighBrackets: {                 // 乙欄の高額給与計算
    threshold: number;
    baseTax: number;
    rate: number;
  }[];
}

// ==================== 令和7年（2025年）の設定 ====================

/**
 * 令和7年分 月額表（甲欄）
 * 88,000円〜740,000円未満
 */
const TAX_TABLE_2025: TaxTableRow[] = [
  // 88,000円〜99,000円（扶養0人のみ課税）
  { min: 88000, max: 89000, taxes: [130, 0, 0, 0, 0, 0, 0, 0] },
  { min: 89000, max: 90000, taxes: [160, 0, 0, 0, 0, 0, 0, 0] },
  { min: 90000, max: 91000, taxes: [190, 0, 0, 0, 0, 0, 0, 0] },
  { min: 91000, max: 92000, taxes: [230, 0, 0, 0, 0, 0, 0, 0] },
  { min: 92000, max: 93000, taxes: [260, 0, 0, 0, 0, 0, 0, 0] },
  { min: 93000, max: 94000, taxes: [290, 0, 0, 0, 0, 0, 0, 0] },
  { min: 94000, max: 95000, taxes: [320, 0, 0, 0, 0, 0, 0, 0] },
  { min: 95000, max: 96000, taxes: [350, 0, 0, 0, 0, 0, 0, 0] },
  { min: 96000, max: 97000, taxes: [380, 0, 0, 0, 0, 0, 0, 0] },
  { min: 97000, max: 98000, taxes: [410, 0, 0, 0, 0, 0, 0, 0] },
  { min: 98000, max: 99000, taxes: [440, 0, 0, 0, 0, 0, 0, 0] },
  // 99,000円〜141,000円
  { min: 99000, max: 101000, taxes: [470, 0, 0, 0, 0, 0, 0, 0] },
  { min: 101000, max: 103000, taxes: [540, 0, 0, 0, 0, 0, 0, 0] },
  { min: 103000, max: 105000, taxes: [610, 0, 0, 0, 0, 0, 0, 0] },
  { min: 105000, max: 107000, taxes: [680, 0, 0, 0, 0, 0, 0, 0] },
  { min: 107000, max: 109000, taxes: [750, 0, 0, 0, 0, 0, 0, 0] },
  { min: 109000, max: 111000, taxes: [820, 0, 0, 0, 0, 0, 0, 0] },
  { min: 111000, max: 113000, taxes: [890, 0, 0, 0, 0, 0, 0, 0] },
  { min: 113000, max: 115000, taxes: [960, 0, 0, 0, 0, 0, 0, 0] },
  { min: 115000, max: 117000, taxes: [1030, 0, 0, 0, 0, 0, 0, 0] },
  { min: 117000, max: 119000, taxes: [1100, 0, 0, 0, 0, 0, 0, 0] },
  { min: 119000, max: 121000, taxes: [1170, 0, 0, 0, 0, 0, 0, 0] },
  { min: 121000, max: 123000, taxes: [1240, 0, 0, 0, 0, 0, 0, 0] },
  { min: 123000, max: 125000, taxes: [1310, 0, 0, 0, 0, 0, 0, 0] },
  { min: 125000, max: 127000, taxes: [1380, 0, 0, 0, 0, 0, 0, 0] },
  { min: 127000, max: 129000, taxes: [1450, 0, 0, 0, 0, 0, 0, 0] },
  { min: 129000, max: 131000, taxes: [1520, 0, 0, 0, 0, 0, 0, 0] },
  { min: 131000, max: 133000, taxes: [1590, 0, 0, 0, 0, 0, 0, 0] },
  { min: 133000, max: 135000, taxes: [1660, 0, 0, 0, 0, 0, 0, 0] },
  { min: 135000, max: 137000, taxes: [1730, 0, 0, 0, 0, 0, 0, 0] },
  { min: 137000, max: 139000, taxes: [1800, 0, 0, 0, 0, 0, 0, 0] },
  { min: 139000, max: 141000, taxes: [1870, 0, 0, 0, 0, 0, 0, 0] },
  // 141,000円〜189,000円（扶養1人から課税開始）
  { min: 141000, max: 143000, taxes: [1940, 310, 0, 0, 0, 0, 0, 0] },
  { min: 143000, max: 145000, taxes: [2010, 380, 0, 0, 0, 0, 0, 0] },
  { min: 145000, max: 147000, taxes: [2080, 450, 0, 0, 0, 0, 0, 0] },
  { min: 147000, max: 149000, taxes: [2150, 520, 0, 0, 0, 0, 0, 0] },
  { min: 149000, max: 151000, taxes: [2220, 590, 0, 0, 0, 0, 0, 0] },
  { min: 151000, max: 153000, taxes: [2980, 660, 0, 0, 0, 0, 0, 0] },
  { min: 153000, max: 155000, taxes: [3050, 730, 0, 0, 0, 0, 0, 0] },
  { min: 155000, max: 157000, taxes: [3120, 800, 0, 0, 0, 0, 0, 0] },
  { min: 157000, max: 159000, taxes: [3190, 870, 0, 0, 0, 0, 0, 0] },
  { min: 159000, max: 161000, taxes: [3260, 940, 0, 0, 0, 0, 0, 0] },
  { min: 161000, max: 163000, taxes: [3330, 1010, 0, 0, 0, 0, 0, 0] },
  { min: 163000, max: 165000, taxes: [3400, 1080, 0, 0, 0, 0, 0, 0] },
  { min: 165000, max: 167000, taxes: [3470, 1150, 0, 0, 0, 0, 0, 0] },
  { min: 167000, max: 169000, taxes: [3540, 1220, 0, 0, 0, 0, 0, 0] },
  { min: 169000, max: 171000, taxes: [3610, 1290, 0, 0, 0, 0, 0, 0] },
  { min: 171000, max: 173000, taxes: [3680, 1360, 0, 0, 0, 0, 0, 0] },
  { min: 173000, max: 175000, taxes: [3750, 1430, 0, 0, 0, 0, 0, 0] },
  { min: 175000, max: 177000, taxes: [3820, 1500, 0, 0, 0, 0, 0, 0] },
  { min: 177000, max: 179000, taxes: [3890, 1570, 0, 0, 0, 0, 0, 0] },
  { min: 179000, max: 181000, taxes: [3960, 1640, 0, 0, 0, 0, 0, 0] },
  { min: 181000, max: 183000, taxes: [4030, 1710, 0, 0, 0, 0, 0, 0] },
  { min: 183000, max: 185000, taxes: [4100, 1780, 0, 0, 0, 0, 0, 0] },
  { min: 185000, max: 187000, taxes: [4170, 1850, 0, 0, 0, 0, 0, 0] },
  { min: 187000, max: 189000, taxes: [4240, 1920, 0, 0, 0, 0, 0, 0] },
  // 189,000円〜235,000円（扶養2人から課税開始）
  { min: 189000, max: 191000, taxes: [4310, 1990, 370, 0, 0, 0, 0, 0] },
  { min: 191000, max: 193000, taxes: [4380, 2060, 440, 0, 0, 0, 0, 0] },
  { min: 193000, max: 195000, taxes: [4450, 2130, 510, 0, 0, 0, 0, 0] },
  { min: 195000, max: 197000, taxes: [4520, 2200, 580, 0, 0, 0, 0, 0] },
  { min: 197000, max: 199000, taxes: [4590, 2270, 650, 0, 0, 0, 0, 0] },
  { min: 199000, max: 201000, taxes: [4660, 2340, 720, 0, 0, 0, 0, 0] },
  { min: 201000, max: 203000, taxes: [5130, 2410, 790, 0, 0, 0, 0, 0] },
  { min: 203000, max: 205000, taxes: [5200, 2480, 860, 0, 0, 0, 0, 0] },
  { min: 205000, max: 207000, taxes: [5270, 2550, 930, 0, 0, 0, 0, 0] },
  { min: 207000, max: 209000, taxes: [5340, 2620, 1000, 0, 0, 0, 0, 0] },
  { min: 209000, max: 211000, taxes: [5410, 2690, 1070, 0, 0, 0, 0, 0] },
  { min: 211000, max: 213000, taxes: [5480, 2760, 1140, 0, 0, 0, 0, 0] },
  { min: 213000, max: 215000, taxes: [5550, 2830, 1210, 0, 0, 0, 0, 0] },
  { min: 215000, max: 217000, taxes: [5620, 2900, 1280, 0, 0, 0, 0, 0] },
  { min: 217000, max: 219000, taxes: [5690, 2970, 1350, 0, 0, 0, 0, 0] },
  { min: 219000, max: 221000, taxes: [5760, 3040, 1420, 0, 0, 0, 0, 0] },
  { min: 221000, max: 223000, taxes: [5830, 3110, 1490, 0, 0, 0, 0, 0] },
  { min: 223000, max: 225000, taxes: [5900, 3180, 1560, 0, 0, 0, 0, 0] },
  { min: 225000, max: 227000, taxes: [5970, 3250, 1630, 0, 0, 0, 0, 0] },
  { min: 227000, max: 229000, taxes: [6040, 3320, 1700, 0, 0, 0, 0, 0] },
  { min: 229000, max: 231000, taxes: [6110, 3390, 1770, 0, 0, 0, 0, 0] },
  { min: 231000, max: 233000, taxes: [6180, 3460, 1840, 0, 0, 0, 0, 0] },
  { min: 233000, max: 235000, taxes: [6250, 3530, 1910, 0, 0, 0, 0, 0] },
  // 235,000円〜284,000円（扶養3人から課税開始）
  { min: 235000, max: 237000, taxes: [6320, 3600, 1980, 360, 0, 0, 0, 0] },
  { min: 237000, max: 239000, taxes: [6390, 3670, 2050, 430, 0, 0, 0, 0] },
  { min: 239000, max: 242000, taxes: [6490, 3770, 2150, 530, 0, 0, 0, 0] },
  { min: 242000, max: 245000, taxes: [6630, 3910, 2290, 670, 0, 0, 0, 0] },
  { min: 245000, max: 248000, taxes: [6780, 4060, 2440, 820, 0, 0, 0, 0] },
  { min: 248000, max: 251000, taxes: [6930, 4210, 2590, 970, 0, 0, 0, 0] },
  { min: 251000, max: 254000, taxes: [7080, 4360, 2740, 1120, 0, 0, 0, 0] },
  { min: 254000, max: 257000, taxes: [7230, 4510, 2890, 1270, 0, 0, 0, 0] },
  { min: 257000, max: 260000, taxes: [7380, 4660, 3040, 1420, 0, 0, 0, 0] },
  { min: 260000, max: 263000, taxes: [7530, 4810, 3190, 1570, 0, 0, 0, 0] },
  { min: 263000, max: 266000, taxes: [7680, 4960, 3340, 1720, 100, 0, 0, 0] },
  { min: 266000, max: 269000, taxes: [7830, 5110, 3490, 1870, 250, 0, 0, 0] },
  { min: 269000, max: 272000, taxes: [7980, 5260, 3640, 2020, 400, 0, 0, 0] },
  { min: 272000, max: 275000, taxes: [8130, 5410, 3790, 2170, 550, 0, 0, 0] },
  { min: 275000, max: 278000, taxes: [8280, 5560, 3940, 2320, 700, 0, 0, 0] },
  { min: 278000, max: 281000, taxes: [8430, 5710, 4090, 2470, 850, 0, 0, 0] },
  { min: 281000, max: 284000, taxes: [8580, 5860, 4240, 2620, 1000, 0, 0, 0] },
  // 284,000円〜331,000円（扶養4人から課税開始）
  { min: 284000, max: 287000, taxes: [8730, 6010, 4390, 2770, 1150, 0, 0, 0] },
  { min: 287000, max: 290000, taxes: [8880, 6160, 4540, 2920, 1300, 0, 0, 0] },
  { min: 290000, max: 293000, taxes: [9030, 6310, 4690, 3070, 1450, 0, 0, 0] },
  { min: 293000, max: 296000, taxes: [9180, 6460, 4840, 3220, 1600, 0, 0, 0] },
  { min: 296000, max: 299000, taxes: [9330, 6610, 4990, 3370, 1750, 130, 0, 0] },
  { min: 299000, max: 302000, taxes: [9480, 6760, 5140, 3520, 1900, 280, 0, 0] },
  { min: 302000, max: 305000, taxes: [9630, 6910, 5290, 3670, 2050, 430, 0, 0] },
  { min: 305000, max: 308000, taxes: [9780, 7060, 5440, 3820, 2200, 580, 0, 0] },
  { min: 308000, max: 311000, taxes: [9930, 7210, 5590, 3970, 2350, 730, 0, 0] },
  { min: 311000, max: 314000, taxes: [10080, 7360, 5740, 4120, 2500, 880, 0, 0] },
  { min: 314000, max: 317000, taxes: [10230, 7510, 5890, 4270, 2650, 1030, 0, 0] },
  { min: 317000, max: 320000, taxes: [10380, 7660, 6040, 4420, 2800, 1180, 0, 0] },
  { min: 320000, max: 323000, taxes: [10530, 7810, 6190, 4570, 2950, 1330, 0, 0] },
  { min: 323000, max: 326000, taxes: [10680, 7960, 6340, 4720, 3100, 1480, 0, 0] },
  { min: 326000, max: 329000, taxes: [10830, 8110, 6490, 4870, 3250, 1630, 10, 0] },
  { min: 329000, max: 332000, taxes: [10980, 8260, 6640, 5020, 3400, 1780, 160, 0] },
  // 332,000円〜379,000円（扶養5人から課税開始）
  { min: 332000, max: 335000, taxes: [11130, 8410, 6790, 5170, 3550, 1930, 310, 0] },
  { min: 335000, max: 338000, taxes: [11280, 8560, 6940, 5320, 3700, 2080, 460, 0] },
  { min: 338000, max: 341000, taxes: [11430, 8710, 7090, 5470, 3850, 2230, 610, 0] },
  { min: 341000, max: 344000, taxes: [11580, 8860, 7240, 5620, 4000, 2380, 760, 0] },
  { min: 344000, max: 347000, taxes: [11730, 9010, 7390, 5770, 4150, 2530, 910, 0] },
  { min: 347000, max: 350000, taxes: [11880, 9160, 7540, 5920, 4300, 2680, 1060, 0] },
  { min: 350000, max: 353000, taxes: [12030, 9310, 7690, 6070, 4450, 2830, 1210, 0] },
  { min: 353000, max: 356000, taxes: [12180, 9460, 7840, 6220, 4600, 2980, 1360, 0] },
  { min: 356000, max: 359000, taxes: [12330, 9610, 7990, 6370, 4750, 3130, 1510, 0] },
  { min: 359000, max: 362000, taxes: [12480, 9760, 8140, 6520, 4900, 3280, 1660, 40] },
  { min: 362000, max: 365000, taxes: [12630, 9910, 8290, 6670, 5050, 3430, 1810, 190] },
  { min: 365000, max: 368000, taxes: [12780, 10060, 8440, 6820, 5200, 3580, 1960, 340] },
  { min: 368000, max: 371000, taxes: [12930, 10210, 8590, 6970, 5350, 3730, 2110, 490] },
  { min: 371000, max: 374000, taxes: [13080, 10360, 8740, 7120, 5500, 3880, 2260, 640] },
  { min: 374000, max: 377000, taxes: [13230, 10510, 8890, 7270, 5650, 4030, 2410, 790] },
  { min: 377000, max: 380000, taxes: [13380, 10660, 9040, 7420, 5800, 4180, 2560, 940] },
  // 380,000円〜740,000円（中間省略、代表的な値のみ）
  { min: 380000, max: 383000, taxes: [13530, 10810, 9190, 7570, 5950, 4330, 2710, 1090] },
  { min: 383000, max: 386000, taxes: [13680, 10960, 9340, 7720, 6100, 4480, 2860, 1240] },
  { min: 386000, max: 389000, taxes: [13830, 11110, 9490, 7870, 6250, 4630, 3010, 1390] },
  { min: 389000, max: 392000, taxes: [13980, 11260, 9640, 8020, 6400, 4780, 3160, 1540] },
  { min: 392000, max: 395000, taxes: [14130, 11410, 9790, 8170, 6550, 4930, 3310, 1690] },
  { min: 395000, max: 398000, taxes: [14280, 11560, 9940, 8320, 6700, 5080, 3460, 1840] },
  { min: 398000, max: 401000, taxes: [14430, 11710, 10090, 8470, 6850, 5230, 3610, 1990] },
  { min: 401000, max: 404000, taxes: [14580, 11860, 10240, 8620, 7000, 5380, 3760, 2140] },
  { min: 404000, max: 407000, taxes: [14730, 12010, 10390, 8770, 7150, 5530, 3910, 2290] },
  { min: 407000, max: 410000, taxes: [14880, 12160, 10540, 8920, 7300, 5680, 4060, 2440] },
  // 410,000円〜500,000円
  { min: 410000, max: 420000, taxes: [15180, 12460, 10840, 9220, 7600, 5980, 4360, 2740] },
  { min: 420000, max: 430000, taxes: [15680, 12960, 11340, 9720, 8100, 6480, 4860, 3240] },
  { min: 430000, max: 440000, taxes: [16180, 13460, 11840, 10220, 8600, 6980, 5360, 3740] },
  { min: 440000, max: 450000, taxes: [16680, 13960, 12340, 10720, 9100, 7480, 5860, 4240] },
  { min: 450000, max: 460000, taxes: [17180, 14460, 12840, 11220, 9600, 7980, 6360, 4740] },
  { min: 460000, max: 470000, taxes: [17680, 14960, 13340, 11720, 10100, 8480, 6860, 5240] },
  { min: 470000, max: 480000, taxes: [18180, 15460, 13840, 12220, 10600, 8980, 7360, 5740] },
  { min: 480000, max: 490000, taxes: [18680, 15960, 14340, 12720, 11100, 9480, 7860, 6240] },
  { min: 490000, max: 500000, taxes: [19180, 16460, 14840, 13220, 11600, 9980, 8360, 6740] },
  // 500,000円〜600,000円
  { min: 500000, max: 520000, taxes: [19930, 17210, 15590, 13970, 12350, 10730, 9110, 7490] },
  { min: 520000, max: 540000, taxes: [21030, 18310, 16690, 15070, 13450, 11830, 10210, 8590] },
  { min: 540000, max: 560000, taxes: [22140, 19420, 17800, 16180, 14560, 12940, 11320, 9700] },
  { min: 560000, max: 580000, taxes: [23250, 20530, 18910, 17290, 15670, 14050, 12430, 10810] },
  { min: 580000, max: 600000, taxes: [24360, 21640, 20020, 18400, 16780, 15160, 13540, 11920] },
  // 600,000円〜740,000円
  { min: 600000, max: 620000, taxes: [25470, 22750, 21130, 19510, 17890, 16270, 14650, 13030] },
  { min: 620000, max: 640000, taxes: [26830, 24110, 22490, 20870, 19250, 17630, 16010, 14390] },
  { min: 640000, max: 660000, taxes: [28400, 25680, 24060, 22440, 20820, 19200, 17580, 15960] },
  { min: 660000, max: 680000, taxes: [30230, 27510, 25890, 24270, 22650, 21030, 19410, 17790] },
  { min: 680000, max: 700000, taxes: [32280, 29560, 27940, 26320, 24700, 23080, 21460, 19840] },
  { min: 700000, max: 720000, taxes: [34560, 31840, 30220, 28600, 26980, 25360, 23740, 22120] },
  { min: 720000, max: 740000, taxes: [37070, 34350, 32730, 31110, 29490, 27870, 26250, 24630] },
];

/**
 * 令和7年分 高額給与（740,000円以上）の速算式用階層定義（甲欄）
 */
const HIGH_INCOME_BRACKETS_2025: HighIncomeBracket[] = [
  { threshold: 740000, rate: 20.420, baseTaxes: [73390, 70670, 69050, 67430, 65810, 64190, 62570, 60950] },
  { threshold: 780000, rate: 23.483, baseTaxes: [81560, 78840, 77220, 75600, 73980, 72360, 70740, 69120] },
  { threshold: 950000, rate: 33.693, baseTaxes: [121480, 118760, 117140, 115520, 113900, 112280, 110660, 109040] },
  { threshold: 1700000, rate: 40.840, baseTaxes: [374180, 371460, 369840, 368220, 366600, 364980, 363360, 361740] },
  { threshold: 2170000, rate: 40.840, baseTaxes: [566180, 563460, 561840, 560220, 558600, 556980, 555360, 553740] },
  { threshold: 3500000, rate: 45.945, baseTaxes: [1125620, 1122900, 1121280, 1119660, 1118040, 1116420, 1114800, 1113180] },
];

// ==================== 令和8年（2026年）の設定 ====================

/**
 * 令和8年分 月額表（甲欄）
 * 105,000円〜740,000円未満
 * ※令和8年は課税開始ラインが105,000円に引き上げ
 */
const TAX_TABLE_2026: TaxTableRow[] = [
  // 105,000円〜141,000円（扶養0人のみ課税）
  { min: 105000, max: 107000, taxes: [100, 0, 0, 0, 0, 0, 0, 0] },
  { min: 107000, max: 109000, taxes: [170, 0, 0, 0, 0, 0, 0, 0] },
  { min: 109000, max: 111000, taxes: [240, 0, 0, 0, 0, 0, 0, 0] },
  { min: 111000, max: 113000, taxes: [310, 0, 0, 0, 0, 0, 0, 0] },
  { min: 113000, max: 115000, taxes: [380, 0, 0, 0, 0, 0, 0, 0] },
  { min: 115000, max: 117000, taxes: [450, 0, 0, 0, 0, 0, 0, 0] },
  { min: 117000, max: 119000, taxes: [520, 0, 0, 0, 0, 0, 0, 0] },
  { min: 119000, max: 121000, taxes: [590, 0, 0, 0, 0, 0, 0, 0] },
  { min: 121000, max: 123000, taxes: [660, 0, 0, 0, 0, 0, 0, 0] },
  { min: 123000, max: 125000, taxes: [730, 0, 0, 0, 0, 0, 0, 0] },
  { min: 125000, max: 127000, taxes: [800, 0, 0, 0, 0, 0, 0, 0] },
  { min: 127000, max: 129000, taxes: [870, 0, 0, 0, 0, 0, 0, 0] },
  { min: 129000, max: 131000, taxes: [940, 0, 0, 0, 0, 0, 0, 0] },
  { min: 131000, max: 133000, taxes: [1010, 0, 0, 0, 0, 0, 0, 0] },
  { min: 133000, max: 135000, taxes: [1080, 0, 0, 0, 0, 0, 0, 0] },
  { min: 135000, max: 137000, taxes: [1150, 0, 0, 0, 0, 0, 0, 0] },
  { min: 137000, max: 139000, taxes: [1220, 0, 0, 0, 0, 0, 0, 0] },
  { min: 139000, max: 141000, taxes: [1290, 0, 0, 0, 0, 0, 0, 0] },
  // 141,000円〜（以下、令和7年と同様の構造で定義）
  // ※実際の運用では国税庁の令和8年分月額表に基づいて正確な値を設定
  { min: 141000, max: 143000, taxes: [1360, 0, 0, 0, 0, 0, 0, 0] },
  { min: 143000, max: 145000, taxes: [1430, 0, 0, 0, 0, 0, 0, 0] },
  { min: 145000, max: 147000, taxes: [1500, 0, 0, 0, 0, 0, 0, 0] },
  { min: 147000, max: 149000, taxes: [1570, 0, 0, 0, 0, 0, 0, 0] },
  { min: 149000, max: 151000, taxes: [1640, 0, 0, 0, 0, 0, 0, 0] },
  { min: 151000, max: 153000, taxes: [2400, 0, 0, 0, 0, 0, 0, 0] },
  { min: 153000, max: 155000, taxes: [2470, 150, 0, 0, 0, 0, 0, 0] },
  { min: 155000, max: 157000, taxes: [2540, 220, 0, 0, 0, 0, 0, 0] },
  { min: 157000, max: 159000, taxes: [2610, 290, 0, 0, 0, 0, 0, 0] },
  { min: 159000, max: 161000, taxes: [2680, 360, 0, 0, 0, 0, 0, 0] },
  { min: 161000, max: 163000, taxes: [2750, 430, 0, 0, 0, 0, 0, 0] },
  { min: 163000, max: 165000, taxes: [2820, 500, 0, 0, 0, 0, 0, 0] },
  { min: 165000, max: 167000, taxes: [2890, 570, 0, 0, 0, 0, 0, 0] },
  { min: 167000, max: 169000, taxes: [2960, 640, 0, 0, 0, 0, 0, 0] },
  { min: 169000, max: 171000, taxes: [3030, 710, 0, 0, 0, 0, 0, 0] },
  { min: 171000, max: 173000, taxes: [3100, 780, 0, 0, 0, 0, 0, 0] },
  { min: 173000, max: 175000, taxes: [3170, 850, 0, 0, 0, 0, 0, 0] },
  { min: 175000, max: 177000, taxes: [3240, 920, 0, 0, 0, 0, 0, 0] },
  { min: 177000, max: 179000, taxes: [3310, 990, 0, 0, 0, 0, 0, 0] },
  { min: 179000, max: 181000, taxes: [3380, 1060, 0, 0, 0, 0, 0, 0] },
  { min: 181000, max: 183000, taxes: [3450, 1130, 0, 0, 0, 0, 0, 0] },
  { min: 183000, max: 185000, taxes: [3520, 1200, 0, 0, 0, 0, 0, 0] },
  { min: 185000, max: 187000, taxes: [3590, 1270, 0, 0, 0, 0, 0, 0] },
  { min: 187000, max: 189000, taxes: [3660, 1340, 0, 0, 0, 0, 0, 0] },
  { min: 189000, max: 191000, taxes: [3730, 1410, 0, 0, 0, 0, 0, 0] },
  { min: 191000, max: 193000, taxes: [3800, 1480, 0, 0, 0, 0, 0, 0] },
  { min: 193000, max: 195000, taxes: [3870, 1550, 0, 0, 0, 0, 0, 0] },
  { min: 195000, max: 197000, taxes: [3940, 1620, 0, 0, 0, 0, 0, 0] },
  { min: 197000, max: 199000, taxes: [4010, 1690, 70, 0, 0, 0, 0, 0] },
  { min: 199000, max: 201000, taxes: [4080, 1760, 140, 0, 0, 0, 0, 0] },
  // 201,000円以上（中間省略、代表的な値）
  { min: 201000, max: 210000, taxes: [4550, 2030, 410, 0, 0, 0, 0, 0] },
  { min: 210000, max: 220000, taxes: [5050, 2530, 910, 0, 0, 0, 0, 0] },
  { min: 220000, max: 230000, taxes: [5550, 3030, 1410, 0, 0, 0, 0, 0] },
  { min: 230000, max: 240000, taxes: [6050, 3530, 1910, 290, 0, 0, 0, 0] },
  { min: 240000, max: 250000, taxes: [6550, 4030, 2410, 790, 0, 0, 0, 0] },
  { min: 250000, max: 260000, taxes: [7050, 4530, 2910, 1290, 0, 0, 0, 0] },
  { min: 260000, max: 270000, taxes: [7550, 5030, 3410, 1790, 170, 0, 0, 0] },
  { min: 270000, max: 280000, taxes: [8050, 5530, 3910, 2290, 670, 0, 0, 0] },
  { min: 280000, max: 290000, taxes: [8550, 6030, 4410, 2790, 1170, 0, 0, 0] },
  { min: 290000, max: 300000, taxes: [9050, 6530, 4910, 3290, 1670, 50, 0, 0] },
  { min: 300000, max: 320000, taxes: [9800, 7280, 5660, 4040, 2420, 800, 0, 0] },
  { min: 320000, max: 340000, taxes: [10800, 8280, 6660, 5040, 3420, 1800, 180, 0] },
  { min: 340000, max: 360000, taxes: [11800, 9280, 7660, 6040, 4420, 2800, 1180, 0] },
  { min: 360000, max: 380000, taxes: [12800, 10280, 8660, 7040, 5420, 3800, 2180, 560] },
  { min: 380000, max: 400000, taxes: [13800, 11280, 9660, 8040, 6420, 4800, 3180, 1560] },
  { min: 400000, max: 420000, taxes: [14800, 12280, 10660, 9040, 7420, 5800, 4180, 2560] },
  { min: 420000, max: 440000, taxes: [15800, 13280, 11660, 10040, 8420, 6800, 5180, 3560] },
  { min: 440000, max: 460000, taxes: [16800, 14280, 12660, 11040, 9420, 7800, 6180, 4560] },
  { min: 460000, max: 480000, taxes: [17800, 15280, 13660, 12040, 10420, 8800, 7180, 5560] },
  { min: 480000, max: 500000, taxes: [18800, 16280, 14660, 13040, 11420, 9800, 8180, 6560] },
  { min: 500000, max: 520000, taxes: [19800, 17280, 15660, 14040, 12420, 10800, 9180, 7560] },
  { min: 520000, max: 540000, taxes: [20900, 18380, 16760, 15140, 13520, 11900, 10280, 8660] },
  { min: 540000, max: 560000, taxes: [22010, 19490, 17870, 16250, 14630, 13010, 11390, 9770] },
  { min: 560000, max: 580000, taxes: [23120, 20600, 18980, 17360, 15740, 14120, 12500, 10880] },
  { min: 580000, max: 600000, taxes: [24230, 21710, 20090, 18470, 16850, 15230, 13610, 11990] },
  { min: 600000, max: 620000, taxes: [25340, 22820, 21200, 19580, 17960, 16340, 14720, 13100] },
  { min: 620000, max: 640000, taxes: [26700, 24180, 22560, 20940, 19320, 17700, 16080, 14460] },
  { min: 640000, max: 660000, taxes: [28270, 25750, 24130, 22510, 20890, 19270, 17650, 16030] },
  { min: 660000, max: 680000, taxes: [30100, 27580, 25960, 24340, 22720, 21100, 19480, 17860] },
  { min: 680000, max: 700000, taxes: [32150, 29630, 28010, 26390, 24770, 23150, 21530, 19910] },
  { min: 700000, max: 720000, taxes: [34430, 31910, 30290, 28670, 27050, 25430, 23810, 22190] },
  { min: 720000, max: 740000, taxes: [36940, 34420, 32800, 31180, 29560, 27940, 26320, 24700] },
];

/**
 * 令和8年分 高額給与（740,000円以上）の速算式用階層定義（甲欄）
 */
const HIGH_INCOME_BRACKETS_2026: HighIncomeBracket[] = [
  { threshold: 740000, rate: 20.420, baseTaxes: [71680, 69160, 67540, 65920, 64300, 62680, 61060, 59440] },
  { threshold: 790000, rate: 23.483, baseTaxes: [81890, 79370, 77750, 76130, 74510, 72890, 71270, 69650] },
  { threshold: 960000, rate: 33.693, baseTaxes: [121820, 119300, 117680, 116060, 114440, 112820, 111200, 109580] },
  { threshold: 1710000, rate: 40.840, baseTaxes: [374520, 372000, 370380, 368760, 367140, 365520, 363900, 362280] },
  { threshold: 2130000, rate: 40.840, baseTaxes: [549440, 546920, 545300, 543680, 542060, 540440, 538820, 537200] },
  { threshold: 2170000, rate: 40.840, baseTaxes: [571220, 568700, 567080, 565460, 563840, 562220, 560600, 558980] },
  { threshold: 2210000, rate: 40.840, baseTaxes: [593000, 590480, 588860, 587240, 585620, 584000, 582380, 580760] },
  { threshold: 2250000, rate: 40.840, baseTaxes: [614770, 612250, 610630, 609010, 607390, 605770, 604150, 602530] },
  { threshold: 3500000, rate: 45.945, baseTaxes: [1125270, 1122750, 1121130, 1119510, 1117890, 1116270, 1114650, 1113030] },
];

// ==================== 年次設定の取得 ====================

/**
 * 対象年の設定を取得
 */
function getYearConfig(year: number): YearConfig {
  if (year >= 2026) {
    return {
      taxFreeThreshold: 105000,
      taxTable: TAX_TABLE_2026,
      highIncomeBrackets: HIGH_INCOME_BRACKETS_2026,
      otsuLowRate: 3.063,
      otsuHighBrackets: [
        { threshold: 740000, baseTax: 259200, rate: 40.84 },
        { threshold: 1710000, baseTax: 655400, rate: 45.945 },
      ],
    };
  } else {
    // 令和7年（2025年）以前
    return {
      taxFreeThreshold: 88000,
      taxTable: TAX_TABLE_2025,
      highIncomeBrackets: HIGH_INCOME_BRACKETS_2025,
      otsuLowRate: 3.063,
      otsuHighBrackets: [
        { threshold: 740000, baseTax: 259800, rate: 40.84 },
        { threshold: 1700000, baseTax: 651900, rate: 45.945 },
      ],
    };
  }
}

// ==================== メイン計算関数 ====================

/**
 * 源泉徴収税額を計算
 *
 * @param year - 対象年（例: 2025, 2026）
 * @param salary - 社会保険料等控除後の給与額
 * @param dependents - 扶養親族等の数（0〜7人以上）
 * @param type - 区分（'甲' または '乙'）
 * @returns 源泉徴収税額（円）
 */
export function calculateWithholdingTaxByYear(
  year: number,
  salary: number,
  dependents: number = 0,
  type: TaxType = '甲'
): number {
  const config = getYearConfig(year);

  // 負の給与は0として扱う
  if (salary <= 0) {
    return 0;
  }

  // パターンA: 課税ライン未満
  if (salary < config.taxFreeThreshold) {
    if (type === '甲') {
      return 0;
    } else {
      // 乙欄: 3.063%（1円未満切り捨て）
      return Math.floor(salary * (config.otsuLowRate / 100));
    }
  }

  // 乙欄の場合
  if (type === '乙') {
    return calculateOtsuTax(salary, config);
  }

  // 甲欄の場合
  return calculateKouTax(salary, dependents, config);
}

/**
 * 甲欄の税額計算
 */
function calculateKouTax(salary: number, dependents: number, config: YearConfig): number {
  // 扶養人数は0〜7人、8人以上は7人として計算後に減額
  const dependentsForTable = Math.min(dependents, 7);
  const extraDependents = Math.max(0, dependents - 7);

  // パターンB: 月額表参照範囲（740,000円未満）
  if (salary < 740000) {
    const row = config.taxTable.find(r => salary >= r.min && salary < r.max);
    if (row) {
      const baseTax = row.taxes[dependentsForTable] || 0;
      const extraDeduction = extraDependents * 1610;
      return Math.max(0, baseTax - extraDeduction);
    }
    // テーブルにない場合は最も近い行を使用
    const lastRow = config.taxTable[config.taxTable.length - 1];
    const baseTax = lastRow.taxes[dependentsForTable] || 0;
    const extraDeduction = extraDependents * 1610;
    return Math.max(0, baseTax - extraDeduction);
  }

  // パターンC: 高額給与の速算式（740,000円以上）
  return calculateHighIncomeTax(salary, dependentsForTable, extraDependents, config.highIncomeBrackets);
}

/**
 * 高額給与（740,000円以上）の税額計算（甲欄）
 */
function calculateHighIncomeTax(
  salary: number,
  dependentsForTable: number,
  extraDependents: number,
  brackets: HighIncomeBracket[]
): number {
  // 該当する階層を検索（降順で検索）
  let applicableBracket: HighIncomeBracket | null = null;
  for (let i = brackets.length - 1; i >= 0; i--) {
    if (salary >= brackets[i].threshold) {
      applicableBracket = brackets[i];
      break;
    }
  }

  if (!applicableBracket) {
    // フォールバック（最初の階層を使用）
    applicableBracket = brackets[0];
  }

  // 基準税額（扶養人数に応じた値）
  const baseTax = applicableBracket.baseTaxes[dependentsForTable] || applicableBracket.baseTaxes[0];
  
  // 超過額に対する税額
  const excessAmount = salary - applicableBracket.threshold;
  const excessTax = Math.floor(excessAmount * (applicableBracket.rate / 100));
  
  // 合計税額
  const totalTax = baseTax + excessTax;
  
  // 8人以上の扶養がある場合、1人につき1,610円減額
  const extraDeduction = extraDependents * 1610;
  
  return Math.max(0, totalTax - extraDeduction);
}

/**
 * 乙欄の税額計算
 */
function calculateOtsuTax(salary: number, config: YearConfig): number {
  // 740,000円未満
  if (salary < 740000) {
    // 乙欄は扶養控除がないため、一律の税率を適用
    // ※実際の乙欄月額表に基づいて計算（ここでは簡易計算）
    // 給与の約3.063%〜約40%程度の税率
    if (salary < config.taxFreeThreshold) {
      return Math.floor(salary * (config.otsuLowRate / 100));
    }
    // 中間帯は概算で計算（実際は月額表参照が必要）
    const baseRate = 3.063 + (salary - config.taxFreeThreshold) / 740000 * 37;
    return Math.floor(salary * (baseRate / 100));
  }

  // 740,000円以上: 速算式
  for (let i = config.otsuHighBrackets.length - 1; i >= 0; i--) {
    const bracket = config.otsuHighBrackets[i];
    if (salary >= bracket.threshold) {
      const excessAmount = salary - bracket.threshold;
      const tax = bracket.baseTax + Math.floor(excessAmount * (bracket.rate / 100));
      return tax;
    }
  }

  // フォールバック
  const firstBracket = config.otsuHighBrackets[0];
  const excessAmount = salary - firstBracket.threshold;
  return firstBracket.baseTax + Math.floor(excessAmount * (firstBracket.rate / 100));
}

// ==================== 後方互換性のための関数 ====================

/**
 * 課税対象額から源泉徴収税を計算（後方互換）
 * 
 * @param taxableAmount - 課税対象額（社会保険料控除後の金額）
 * @param dependents - 扶養人数（0〜7人以上）
 * @returns 源泉徴収税額（円）
 * 
 * @deprecated calculateWithholdingTaxByYear() を使用してください
 */
export function calculateWithholdingTax(taxableAmount: number, dependents: number = 0): number {
  // 現在の年を取得して適切な計算を行う
  const currentYear = new Date().getFullYear();
  return calculateWithholdingTaxByYear(currentYear, taxableAmount, dependents, '甲');
}

// ==================== ユーティリティ関数 ====================

/**
 * 税額テーブルの範囲を取得（デバッグ用）
 */
export function getTaxTableRange(year: number = new Date().getFullYear()): { min: number; max: number } {
  const config = getYearConfig(year);
  return {
    min: config.taxFreeThreshold,
    max: 740000,
  };
}

/**
 * 対象年の課税開始ラインを取得
 */
export function getTaxFreeThreshold(year: number): number {
  return getYearConfig(year).taxFreeThreshold;
}

/**
 * 対象年が令和何年かを取得
 */
export function getReiwaNen(year: number): number {
  return year - 2018; // 令和元年 = 2019年
}

import { useRef, useEffect, useState } from 'react';
import type { Helper, Shift } from '../types';
import { getGoogleAccessToken } from '../services/googleAuthService';
import { getSpreadsheetData, parseSpreadsheetData, downloadSpreadsheetDataAsJson, type SpreadsheetData } from '../services/spreadsheetService';

interface Props {
  helpers: Helper[];
  shifts: Shift[];
  year: number;
  month: number;
  onUpdateShifts: (shifts: Shift[] | ((prev: Shift[]) => Shift[])) => void;
}

const SPREADSHEET_ID = '1hrNbQ3X9bkFqNe3zoZgs3vQF54K2rmFxXNJm_0Xg5m0';
const SHEET_ID = 503376053;

export function ShiftTable({ year, month, helpers }: Props) {
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const [spreadsheetData, setSpreadsheetData] = useState<SpreadsheetData | null>(null);
  const [isFetching, setIsFetching] = useState(false);

  const spreadsheetUrl = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit?gid=${SHEET_ID}&rm=minimal`;

  const handleOpenInNewTab = () => {
    window.open(
      `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit?gid=${SHEET_ID}`,
      '_blank',
      'noopener,noreferrer'
    );
  };

  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const handleFetchSpreadsheetData = async () => {
    setIsFetching(true);
    try {
      console.log('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');

      // Google OAuthèªè¨¼
      const accessToken = await getGoogleAccessToken();

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const rawData = await getSpreadsheetData(accessToken);

      // ãƒ‡ãƒ¼ã‚¿ã‚’è§£æ
      const parsedData = parseSpreadsheetData(rawData);

      console.log('=== ã‚¹ãƒ—ã‚·ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº† ===');
      console.log('è¡Œæ•°:', parsedData.rowCount);
      console.log('åˆ—æ•°:', parsedData.columnCount);
      console.log('ã‚»ãƒ«æ•°:', parsedData.cells.length);
      console.log('ãƒãƒ¼ã‚¸æ•°:', parsedData.merges.length);
      console.log('åˆ—å¹…:', parsedData.columnWidths);
      console.log('å…¨ãƒ‡ãƒ¼ã‚¿:', parsedData);

      // ã‚¹ãƒ†ãƒ¼ãƒˆã«ä¿å­˜
      setSpreadsheetData(parsedData);

      // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      downloadSpreadsheetDataAsJson(parsedData, `spreadsheet-data-${year}-${month}.json`);

      alert('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼\nJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚\nã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');

    } catch (error: any) {
      console.error('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      alert(`âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:\n${error.message}`);
    } finally {
      setIsFetching(false);
    }
  };

  // ãƒ˜ãƒ«ãƒ‘ãƒ¼æ•°ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã«iframeã‚’ãƒªãƒ­ãƒ¼ãƒ‰
  useEffect(() => {
    if (iframeRef.current) {
      console.log(`ğŸ”„ ãƒ˜ãƒ«ãƒ‘ãƒ¼æ•°å¤‰æ›´æ¤œçŸ¥: ${helpers.length}äºº`);
      // iframeã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°ã®åˆ—ã‚’åæ˜ 
      const currentSrc = iframeRef.current.src;
      iframeRef.current.src = '';
      setTimeout(() => {
        if (iframeRef.current) {
          iframeRef.current.src = currentSrc;
        }
      }, 100);
    }
  }, [helpers.length]);

  return (
    <div
      className="w-full"
      style={{
        height: 'calc(100vh - 180px)',
        overscrollBehaviorX: 'none',
        touchAction: 'pan-y pinch-zoom'
      }}
    >
      <div className="mb-2 flex items-center justify-between">
        <div className="text-sm text-gray-600">
          {year}å¹´{month}æœˆã®ã‚·ãƒ•ãƒˆè¡¨ï¼ˆGoogleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰
          {spreadsheetData && (
            <span className="ml-2 text-xs text-green-600">
              âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æ¸ˆã¿ ({spreadsheetData.cells.length}ã‚»ãƒ«)
            </span>
          )}
        </div>
        <div className="flex gap-2">
          <button
            onClick={handleFetchSpreadsheetData}
            disabled={isFetching}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            title="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            {isFetching ? 'å–å¾—ä¸­...' : 'ã‚¹ãƒ—ã‚·ãƒ‡ãƒ¼ã‚¿å–å¾—'}
          </button>
          <button
            onClick={handleOpenInNewTab}
            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center gap-2"
            title="æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã„ã¦ç·¨é›†"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            æ–°ã—ã„ã‚¿ãƒ–ã§ç·¨é›†
          </button>
        </div>
      </div>
      <iframe
        ref={iframeRef}
        src={spreadsheetUrl}
        width="100%"
        height="100%"
        style={{ border: '1px solid #e5e7eb', borderRadius: '8px' }}
        allow="clipboard-read; clipboard-write"
        sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-modals"
        title={`${year}å¹´${month}æœˆã‚·ãƒ•ãƒˆè¡¨`}
      />
    </div>
  );
}
